"""
Vulnerability Score Modeler & Optimizer GUI.

A graphical user interface for analyzing and optimizing vulnerability score parameters.

This tool allows users to:
1. Load completed backtest results
2. Configure vulnerability score parameters
3. Run simulations to see swap impact
4. Visualize results and optimize parameters
5. Export/import configurations

Usage:
    python vulnerability_gui.py
"""

import tkinter as tk
from tkinter import ttk, messagebox, filedialog, simpledialog
from pathlib import Path
from datetime import datetime
from typing import Dict, List, Any, Optional
import json
import traceback

from Classes.VulnerabilityScorer.loader import BacktestTradeLoader, DataAvailabilityReport
from Classes.VulnerabilityScorer.scoring import (
    VulnerabilityScoreParams,
    VulnerabilityScoringEngine,
    VULNERABILITY_SCORE_PRESETS
)
from Classes.VulnerabilityScorer.analyzer import VulnerabilityAnalyzer, VulnerabilityAnalysisReport
from Classes.VulnerabilityScorer.features import AVAILABLE_FEATURES, FeatureWeight, FeatureError
from Classes.Config.capital_contention import (
    EnhancedVulnerabilityConfig,
    ENHANCED_FEATURE_DEFINITIONS
)
from Classes.GUI.vulnerability_plots import (
    VulnerabilityChartFrame,
    plot_vulnerability_timeline,
    plot_pl_comparison,
    plot_trade_categorization,
    plot_feature_contributions,
    plot_swap_events_timeline,
    plot_cumulative_pl_impact
)
from Classes.Data.data_loader import DataLoader


class VulnerabilityModelerGUI:
    """Main GUI application for Vulnerability Score Modeler."""

    def __init__(self, root: tk.Tk):
        """Initialize the GUI."""
        self.root = root
        self.root.title("Vulnerability Score Modeler & Optimizer")
        self.root.geometry("1400x900")
        self.root.minsize(1200, 700)

        # Initialize data
        self.data_directory = Path('raw_data')
        self.data_loader: Optional[BacktestTradeLoader] = None
        self.trades: List[Dict[str, Any]] = []
        self.price_data: Dict[str, Any] = {}
        self.current_report: Optional[VulnerabilityAnalysisReport] = None

        # Parameters
        self.params = VulnerabilityScoreParams()
        self.feature_vars: Dict[str, Dict[str, tk.Variable]] = {}

        # Create UI
        self._create_menu()
        self._create_main_layout()
        self._load_presets()

    def _create_menu(self):
        """Create menu bar."""
        menubar = tk.Menu(self.root)
        self.root.config(menu=menubar)

        # File menu
        file_menu = tk.Menu(menubar, tearoff=0)
        menubar.add_cascade(label="File", menu=file_menu)
        file_menu.add_command(label="Load Trade Log...", command=self._load_trade_log)
        file_menu.add_command(label="Set Data Directory...", command=self._set_data_directory)
        file_menu.add_separator()
        file_menu.add_command(label="Export Report...", command=self._export_report)
        file_menu.add_command(label="Export Parameters...", command=self._export_params)
        file_menu.add_command(label="Import Parameters...", command=self._import_params)
        file_menu.add_separator()
        file_menu.add_command(label="Exit", command=self.root.quit)

        # Tools menu
        tools_menu = tk.Menu(menubar, tearoff=0)
        menubar.add_cascade(label="Tools", menu=tools_menu)
        tools_menu.add_command(label="Find Optimal Parameters", command=self._find_optimal)
        tools_menu.add_command(label="Compare Presets", command=self._compare_presets)

        # Help menu
        help_menu = tk.Menu(menubar, tearoff=0)
        menubar.add_cascade(label="Help", menu=help_menu)
        help_menu.add_command(label="About", command=self._show_about)

    def _create_main_layout(self):
        """Create main layout with panels."""
        # Main paned window
        main_pane = ttk.PanedWindow(self.root, orient=tk.HORIZONTAL)
        main_pane.pack(fill=tk.BOTH, expand=True, padx=5, pady=5)

        # Left panel - Configuration
        left_frame = ttk.Frame(main_pane)
        main_pane.add(left_frame, weight=1)
        self._create_config_panel(left_frame)

        # Right panel - Results and Charts
        right_frame = ttk.Frame(main_pane)
        main_pane.add(right_frame, weight=2)
        self._create_results_panel(right_frame)

    def _create_config_panel(self, parent: ttk.Frame):
        """Create the configuration panel."""
        parent.columnconfigure(0, weight=1)
        parent.rowconfigure(2, weight=1)

        # Data Loading Section
        data_frame = ttk.LabelFrame(parent, text="Data", padding="10")
        data_frame.grid(row=0, column=0, sticky='ew', padx=5, pady=5)

        ttk.Button(data_frame, text="Load Trade Log", command=self._load_trade_log).pack(fill=tk.X, pady=2)

        self.data_status_var = tk.StringVar(value="No data loaded")
        ttk.Label(data_frame, textvariable=self.data_status_var,
                 font=('TkDefaultFont', 9, 'italic')).pack(fill=tk.X, pady=5)

        # Preset Selection
        preset_frame = ttk.LabelFrame(parent, text="Preset", padding="10")
        preset_frame.grid(row=1, column=0, sticky='ew', padx=5, pady=5)

        self.preset_var = tk.StringVar(value="default")
        preset_combo = ttk.Combobox(preset_frame, textvariable=self.preset_var, state='readonly', width=25)
        preset_combo.pack(fill=tk.X, pady=2)
        preset_combo.bind('<<ComboboxSelected>>', self._on_preset_selected)

        # Parameters Section (scrollable)
        params_frame = ttk.LabelFrame(parent, text="Parameters", padding="5")
        params_frame.grid(row=2, column=0, sticky='nsew', padx=5, pady=5)
        params_frame.columnconfigure(0, weight=1)
        params_frame.rowconfigure(0, weight=1)

        # Canvas for scrolling
        canvas = tk.Canvas(params_frame, highlightthickness=0)
        scrollbar = ttk.Scrollbar(params_frame, orient="vertical", command=canvas.yview)
        self.params_inner_frame = ttk.Frame(canvas)

        self.params_inner_frame.bind(
            "<Configure>",
            lambda e: canvas.configure(scrollregion=canvas.bbox("all"))
        )

        canvas.create_window((0, 0), window=self.params_inner_frame, anchor="nw")
        canvas.configure(yscrollcommand=scrollbar.set)

        canvas.grid(row=0, column=0, sticky='nsew')
        scrollbar.grid(row=0, column=1, sticky='ns')

        self._create_parameter_widgets()

        # Run Button
        run_frame = ttk.Frame(parent, padding="10")
        run_frame.grid(row=3, column=0, sticky='ew', padx=5, pady=5)

        ttk.Button(run_frame, text="Run Analysis", command=self._run_analysis,
                  style='Accent.TButton').pack(fill=tk.X, pady=5)

    def _create_parameter_widgets(self):
        """Create parameter input widgets."""
        frame = self.params_inner_frame

        # Clear existing widgets
        for widget in frame.winfo_children():
            widget.destroy()

        row = 0

        # Core Parameters
        ttk.Label(frame, text="Core Parameters", font=('TkDefaultFont', 10, 'bold')).grid(
            row=row, column=0, columnspan=2, sticky='w', padx=5, pady=(10, 5)
        )
        row += 1

        # Immunity Days
        ttk.Label(frame, text="Immunity Days:").grid(row=row, column=0, sticky='w', padx=5, pady=2)
        self.immunity_var = tk.IntVar(value=self.params.immunity_days)
        ttk.Spinbox(frame, from_=1, to=30, textvariable=self.immunity_var, width=10).grid(
            row=row, column=1, sticky='w', padx=5, pady=2
        )
        row += 1

        # Swap Threshold
        ttk.Label(frame, text="Swap Threshold:").grid(row=row, column=0, sticky='w', padx=5, pady=2)
        self.threshold_var = tk.DoubleVar(value=self.params.swap_threshold)
        ttk.Spinbox(frame, from_=10, to=90, textvariable=self.threshold_var, width=10).grid(
            row=row, column=1, sticky='w', padx=5, pady=2
        )
        row += 1

        # Base Score
        ttk.Label(frame, text="Base Score:").grid(row=row, column=0, sticky='w', padx=5, pady=2)
        self.base_score_var = tk.DoubleVar(value=self.params.base_score)
        ttk.Entry(frame, textvariable=self.base_score_var, width=10, state='readonly').grid(
            row=row, column=1, sticky='w', padx=5, pady=2
        )
        row += 1

        # Feature Weights Section
        ttk.Separator(frame, orient='horizontal').grid(row=row, column=0, columnspan=2, sticky='ew', pady=10)
        row += 1

        ttk.Label(frame, text="Feature Weights", font=('TkDefaultFont', 10, 'bold')).grid(
            row=row, column=0, columnspan=2, sticky='w', padx=5, pady=(5, 5)
        )
        row += 1

        # Create widgets for each feature
        self.feature_vars = {}

        for feature_name, definition in ENHANCED_FEATURE_DEFINITIONS.items():
            self.feature_vars[feature_name] = {}

            # Feature enable checkbox
            enabled_var = tk.BooleanVar(value=False)
            self.feature_vars[feature_name]['enabled'] = enabled_var

            chk = ttk.Checkbutton(frame, text=definition['name'], variable=enabled_var,
                                 command=lambda fn=feature_name: self._on_feature_toggle(fn))
            chk.grid(row=row, column=0, sticky='w', padx=5, pady=2)

            # Weight entry
            weight_var = tk.DoubleVar(value=definition['recommended_weight'])
            self.feature_vars[feature_name]['weight'] = weight_var

            weight_entry = ttk.Entry(frame, textvariable=weight_var, width=8)
            weight_entry.grid(row=row, column=1, sticky='w', padx=5, pady=2)

            row += 1

        # Initialize feature values from current params
        self._load_feature_values()

    def _load_feature_values(self):
        """Load feature values from current params."""
        for feature_name, weight in self.params.features.items():
            if feature_name in self.feature_vars:
                self.feature_vars[feature_name]['enabled'].set(weight.enabled)
                self.feature_vars[feature_name]['weight'].set(weight.weight)

    def _on_feature_toggle(self, feature_name: str):
        """Handle feature enable/disable toggle."""
        pass  # Widget state is tracked by variable

    def _create_results_panel(self, parent: ttk.Frame):
        """Create the results panel with tabs."""
        parent.columnconfigure(0, weight=1)
        parent.rowconfigure(0, weight=1)

        # Notebook for tabs
        self.notebook = ttk.Notebook(parent)
        self.notebook.grid(row=0, column=0, sticky='nsew', padx=5, pady=5)

        # Summary Tab
        summary_frame = ttk.Frame(self.notebook, padding="10")
        self.notebook.add(summary_frame, text="Summary")
        self._create_summary_tab(summary_frame)

        # Trade Analysis Tab
        trades_frame = ttk.Frame(self.notebook, padding="10")
        self.notebook.add(trades_frame, text="Trade Analysis")
        self._create_trades_tab(trades_frame)

        # Charts Tab
        charts_frame = ttk.Frame(self.notebook, padding="10")
        self.notebook.add(charts_frame, text="Charts")
        self._create_charts_tab(charts_frame)

        # Swap Events Tab
        swaps_frame = ttk.Frame(self.notebook, padding="10")
        self.notebook.add(swaps_frame, text="Swap Events")
        self._create_swaps_tab(swaps_frame)

    def _create_summary_tab(self, parent: ttk.Frame):
        """Create the summary tab."""
        parent.columnconfigure(0, weight=1)
        parent.rowconfigure(0, weight=1)

        # Summary text
        self.summary_text = tk.Text(parent, wrap=tk.WORD, font=('Consolas', 10))
        self.summary_text.grid(row=0, column=0, sticky='nsew')

        scrollbar = ttk.Scrollbar(parent, orient='vertical', command=self.summary_text.yview)
        scrollbar.grid(row=0, column=1, sticky='ns')
        self.summary_text.configure(yscrollcommand=scrollbar.set)

        self.summary_text.insert('1.0', "No analysis run yet. Load data and click 'Run Analysis'.")
        self.summary_text.configure(state='disabled')

    def _create_trades_tab(self, parent: ttk.Frame):
        """Create the trade analysis tab."""
        parent.columnconfigure(0, weight=1)
        parent.rowconfigure(0, weight=1)

        # Treeview for trade analysis
        columns = ('trade_id', 'symbol', 'natural_pl', 'vuln_pl', 'difference', 'category')
        self.trades_tree = ttk.Treeview(parent, columns=columns, show='headings')

        self.trades_tree.heading('trade_id', text='Trade ID')
        self.trades_tree.heading('symbol', text='Symbol')
        self.trades_tree.heading('natural_pl', text='Natural P/L')
        self.trades_tree.heading('vuln_pl', text='Vuln P/L')
        self.trades_tree.heading('difference', text='Difference')
        self.trades_tree.heading('category', text='Category')

        self.trades_tree.column('trade_id', width=80)
        self.trades_tree.column('symbol', width=80)
        self.trades_tree.column('natural_pl', width=100)
        self.trades_tree.column('vuln_pl', width=100)
        self.trades_tree.column('difference', width=100)
        self.trades_tree.column('category', width=120)

        self.trades_tree.grid(row=0, column=0, sticky='nsew')

        scrollbar = ttk.Scrollbar(parent, orient='vertical', command=self.trades_tree.yview)
        scrollbar.grid(row=0, column=1, sticky='ns')
        self.trades_tree.configure(yscrollcommand=scrollbar.set)

        # Bind selection to show trade details
        self.trades_tree.bind('<<TreeviewSelect>>', self._on_trade_selected)

    def _create_charts_tab(self, parent: ttk.Frame):
        """Create the charts tab."""
        parent.columnconfigure(0, weight=1)
        parent.columnconfigure(1, weight=1)
        parent.rowconfigure(0, weight=1)
        parent.rowconfigure(1, weight=1)

        # Create chart frames
        self.chart_categorization = VulnerabilityChartFrame(parent, figsize=(5, 4))
        self.chart_categorization.grid(row=0, column=0, sticky='nsew', padx=2, pady=2)

        self.chart_cumulative = VulnerabilityChartFrame(parent, figsize=(5, 4))
        self.chart_cumulative.grid(row=0, column=1, sticky='nsew', padx=2, pady=2)

        self.chart_pl_comparison = VulnerabilityChartFrame(parent, figsize=(5, 4))
        self.chart_pl_comparison.grid(row=1, column=0, sticky='nsew', padx=2, pady=2)

        self.chart_timeline = VulnerabilityChartFrame(parent, figsize=(5, 4))
        self.chart_timeline.grid(row=1, column=1, sticky='nsew', padx=2, pady=2)

    def _create_swaps_tab(self, parent: ttk.Frame):
        """Create the swap events tab."""
        parent.columnconfigure(0, weight=1)
        parent.rowconfigure(0, weight=1)

        # Treeview for swap events
        columns = ('date', 'symbol', 'score', 'reason', 'days_held', 'pl_diff', 'outcome')
        self.swaps_tree = ttk.Treeview(parent, columns=columns, show='headings')

        self.swaps_tree.heading('date', text='Date')
        self.swaps_tree.heading('symbol', text='Symbol')
        self.swaps_tree.heading('score', text='Score')
        self.swaps_tree.heading('reason', text='Reason')
        self.swaps_tree.heading('days_held', text='Days Early')
        self.swaps_tree.heading('pl_diff', text='P/L Diff')
        self.swaps_tree.heading('outcome', text='Outcome')

        self.swaps_tree.column('date', width=100)
        self.swaps_tree.column('symbol', width=80)
        self.swaps_tree.column('score', width=60)
        self.swaps_tree.column('reason', width=100)
        self.swaps_tree.column('days_held', width=80)
        self.swaps_tree.column('pl_diff', width=80)
        self.swaps_tree.column('outcome', width=100)

        self.swaps_tree.grid(row=0, column=0, sticky='nsew')

        scrollbar = ttk.Scrollbar(parent, orient='vertical', command=self.swaps_tree.yview)
        scrollbar.grid(row=0, column=1, sticky='ns')
        self.swaps_tree.configure(yscrollcommand=scrollbar.set)

    def _load_presets(self):
        """Load available presets into combo box."""
        presets = list(VULNERABILITY_SCORE_PRESETS.keys())

        # Find the preset combo in config panel
        for child in self.root.winfo_children():
            self._find_and_update_preset_combo(child, presets)

    def _find_and_update_preset_combo(self, widget, presets):
        """Recursively find and update preset combo."""
        if isinstance(widget, ttk.Combobox):
            if widget.cget('textvariable') == str(self.preset_var):
                widget['values'] = presets
                return
        for child in widget.winfo_children():
            self._find_and_update_preset_combo(child, presets)

    def _on_preset_selected(self, event):
        """Handle preset selection."""
        preset_name = self.preset_var.get()
        if preset_name in VULNERABILITY_SCORE_PRESETS:
            self.params = VULNERABILITY_SCORE_PRESETS[preset_name]
            self.immunity_var.set(self.params.immunity_days)
            self.threshold_var.set(self.params.swap_threshold)
            self.base_score_var.set(self.params.base_score)
            self._load_feature_values()

    def _set_data_directory(self):
        """Set the data directory."""
        directory = filedialog.askdirectory(
            title="Select Data Directory",
            initialdir=str(self.data_directory)
        )
        if directory:
            self.data_directory = Path(directory)
            self.data_status_var.set(f"Data dir: {self.data_directory}")

    def _load_trade_log(self):
        """Load a trade log file."""
        filepath = filedialog.askopenfilename(
            title="Select Trade Log",
            filetypes=[("CSV files", "*.csv"), ("All files", "*.*")],
            initialdir=str(Path('logs'))
        )

        if not filepath:
            return

        try:
            self.data_loader = BacktestTradeLoader(self.data_directory)
            self.trades, self.price_data, report = self.data_loader.load_from_trade_log(
                Path(filepath)
            )

            if not report.is_valid:
                messagebox.showwarning("Data Warning", report.get_summary())

            self.data_status_var.set(f"Loaded {len(self.trades)} trades")
            messagebox.showinfo("Success", f"Loaded {len(self.trades)} trades from {len(self.price_data)} symbols")

        except Exception as e:
            messagebox.showerror("Error", f"Failed to load trade log:\n{str(e)}")
            traceback.print_exc()

    def _get_current_params(self) -> VulnerabilityScoreParams:
        """Get current parameters from UI."""
        features = {}

        for feature_name, vars_dict in self.feature_vars.items():
            features[feature_name] = FeatureWeight(
                enabled=vars_dict['enabled'].get(),
                weight=vars_dict['weight'].get()
            )

        return VulnerabilityScoreParams(
            name="Custom",
            description="User-defined parameters",
            immunity_days=self.immunity_var.get(),
            base_score=self.base_score_var.get(),
            swap_threshold=self.threshold_var.get(),
            features=features
        )

    def _run_analysis(self):
        """Run the vulnerability analysis."""
        if not self.trades:
            messagebox.showwarning("No Data", "Please load a trade log first.")
            return

        try:
            # Get current parameters
            params = self._get_current_params()

            # Run analysis
            analyzer = VulnerabilityAnalyzer(params)
            self.current_report = analyzer.analyze_backtest(self.trades, self.price_data)

            # Update UI
            self._update_summary()
            self._update_trades_table()
            self._update_charts()
            self._update_swaps_table()

            self.notebook.select(0)  # Switch to summary tab

            messagebox.showinfo("Analysis Complete",
                              f"Analysis complete!\n\n"
                              f"Trades affected: {self.current_report.trades_affected_by_vulnerability}\n"
                              f"P/L difference: ${self.current_report.total_pl_difference:,.2f}")

        except FeatureError as e:
            messagebox.showerror("Feature Error", str(e))
        except Exception as e:
            messagebox.showerror("Error", f"Analysis failed:\n{str(e)}")
            traceback.print_exc()

    def _update_summary(self):
        """Update the summary tab."""
        if not self.current_report:
            return

        self.summary_text.configure(state='normal')
        self.summary_text.delete('1.0', tk.END)

        # Add summary text
        self.summary_text.insert('1.0', self.current_report.get_summary_text())
        self.summary_text.insert(tk.END, "\n\n")
        self.summary_text.insert(tk.END, "=" * 50 + "\n")
        self.summary_text.insert(tk.END, "KEY INSIGHT\n")
        self.summary_text.insert(tk.END, "=" * 50 + "\n")
        self.summary_text.insert(tk.END, self.current_report.get_key_insight())
        self.summary_text.insert(tk.END, "\n\n")
        self.summary_text.insert(tk.END, "=" * 50 + "\n")
        self.summary_text.insert(tk.END, "RECOMMENDATION\n")
        self.summary_text.insert(tk.END, "=" * 50 + "\n")
        self.summary_text.insert(tk.END, self.current_report.get_recommendation())

        self.summary_text.configure(state='disabled')

    def _update_trades_table(self):
        """Update the trades table."""
        # Clear existing items
        for item in self.trades_tree.get_children():
            self.trades_tree.delete(item)

        if not self.current_report:
            return

        for trade in self.current_report.trades:
            self.trades_tree.insert('', 'end', values=(
                trade.trade_id,
                trade.symbol,
                f"${trade.pl_natural_dollars:,.2f}",
                f"${trade.pl_if_exited_at_vulnerability_dollars:,.2f}",
                f"${trade.pl_difference_dollars:+,.2f}",
                trade.benefit_category
            ))

    def _update_charts(self):
        """Update all charts."""
        if not self.current_report:
            return

        # Categorization pie chart
        not_affected = self.current_report.total_trades - self.current_report.trades_affected_by_vulnerability
        plot_trade_categorization(
            self.chart_categorization,
            self.current_report.benefited_count,
            self.current_report.hurt_count,
            self.current_report.neutral_count,
            not_affected
        )

        # Cumulative P/L chart
        trades_dicts = [t.to_dict() for t in self.current_report.trades]
        plot_cumulative_pl_impact(self.chart_cumulative, trades_dicts)

        # P/L comparison chart
        plot_pl_comparison(self.chart_pl_comparison, trades_dicts)

        # Timeline chart for first affected trade
        affected = [t for t in self.current_report.trades if t.would_have_been_swapped]
        if affected and affected[0].daily_timeline:
            timeline_dicts = [r.to_dict() for r in affected[0].daily_timeline]
            params = self._get_current_params()
            plot_vulnerability_timeline(
                self.chart_timeline,
                timeline_dicts,
                params.swap_threshold,
                params.immunity_days,
                f"Timeline: {affected[0].trade_id}"
            )

    def _update_swaps_table(self):
        """Update the swap events table."""
        # Clear existing items
        for item in self.swaps_tree.get_children():
            self.swaps_tree.delete(item)

        if not self.current_report:
            return

        for trade in self.current_report.trades:
            if trade.would_have_been_swapped and trade.first_vulnerable_date:
                self.swaps_tree.insert('', 'end', values=(
                    trade.first_vulnerable_date.strftime('%Y-%m-%d') if hasattr(trade.first_vulnerable_date, 'strftime') else str(trade.first_vulnerable_date),
                    trade.symbol,
                    f"{trade.first_vulnerable_score:.1f}",
                    trade.benefit_category,
                    trade.days_before_vulnerability_exit,
                    f"{trade.pl_difference_pct:+.2f}%",
                    trade.benefit_category
                ))

    def _on_trade_selected(self, event):
        """Handle trade selection in treeview."""
        selection = self.trades_tree.selection()
        if not selection or not self.current_report:
            return

        # Get selected trade
        item = self.trades_tree.item(selection[0])
        trade_id = item['values'][0]

        # Find the trade analysis
        trade = next((t for t in self.current_report.trades if t.trade_id == trade_id), None)
        if trade and trade.daily_timeline:
            # Update timeline chart for selected trade
            timeline_dicts = [r.to_dict() for r in trade.daily_timeline]
            params = self._get_current_params()
            plot_vulnerability_timeline(
                self.chart_timeline,
                timeline_dicts,
                params.swap_threshold,
                params.immunity_days,
                f"Timeline: {trade_id}"
            )

    def _export_report(self):
        """Export the analysis report."""
        if not self.current_report:
            messagebox.showwarning("No Report", "Please run an analysis first.")
            return

        filepath = filedialog.asksaveasfilename(
            title="Export Report",
            defaultextension=".json",
            filetypes=[("JSON files", "*.json"), ("CSV files", "*.csv"), ("All files", "*.*")]
        )

        if not filepath:
            return

        try:
            if filepath.endswith('.csv'):
                self.current_report.to_csv(Path(filepath))
            else:
                self.current_report.to_json(Path(filepath))
            messagebox.showinfo("Success", f"Report exported to {filepath}")
        except Exception as e:
            messagebox.showerror("Error", f"Export failed: {str(e)}")

    def _export_params(self):
        """Export current parameters to JSON."""
        filepath = filedialog.asksaveasfilename(
            title="Export Parameters",
            defaultextension=".json",
            filetypes=[("JSON files", "*.json"), ("All files", "*.*")]
        )

        if not filepath:
            return

        try:
            params = self._get_current_params()
            params.to_json(Path(filepath))
            messagebox.showinfo("Success", f"Parameters exported to {filepath}")
        except Exception as e:
            messagebox.showerror("Error", f"Export failed: {str(e)}")

    def _import_params(self):
        """Import parameters from JSON."""
        filepath = filedialog.askopenfilename(
            title="Import Parameters",
            filetypes=[("JSON files", "*.json"), ("All files", "*.*")]
        )

        if not filepath:
            return

        try:
            self.params = VulnerabilityScoreParams.from_json(Path(filepath))
            self.immunity_var.set(self.params.immunity_days)
            self.threshold_var.set(self.params.swap_threshold)
            self.base_score_var.set(self.params.base_score)
            self._load_feature_values()
            messagebox.showinfo("Success", "Parameters imported successfully")
        except Exception as e:
            messagebox.showerror("Error", f"Import failed: {str(e)}")

    def _find_optimal(self):
        """Find optimal parameters using grid search."""
        if not self.trades:
            messagebox.showwarning("No Data", "Please load a trade log first.")
            return

        result = messagebox.askyesno(
            "Find Optimal Parameters",
            "This will test multiple parameter combinations.\n"
            "This may take a few minutes.\n\n"
            "Continue?"
        )

        if not result:
            return

        try:
            analyzer = VulnerabilityAnalyzer()
            best_params, best_report = analyzer.find_optimal_parameters(
                self.trades, self.price_data
            )

            # Update UI with best params
            self.params = best_params
            self.immunity_var.set(best_params.immunity_days)
            self.threshold_var.set(best_params.swap_threshold)
            self._load_feature_values()

            self.current_report = best_report
            self._update_summary()
            self._update_trades_table()
            self._update_charts()
            self._update_swaps_table()

            messagebox.showinfo(
                "Optimization Complete",
                f"Optimal parameters found:\n\n"
                f"Immunity Days: {best_params.immunity_days}\n"
                f"Swap Threshold: {best_params.swap_threshold}\n"
                f"P/L Improvement: ${best_report.total_pl_difference:,.2f}"
            )

        except Exception as e:
            messagebox.showerror("Error", f"Optimization failed: {str(e)}")
            traceback.print_exc()

    def _compare_presets(self):
        """Compare all presets."""
        if not self.trades:
            messagebox.showwarning("No Data", "Please load a trade log first.")
            return

        try:
            results = []
            for name, params in VULNERABILITY_SCORE_PRESETS.items():
                analyzer = VulnerabilityAnalyzer(params)
                report = analyzer.analyze_backtest(self.trades, self.price_data)
                results.append({
                    'name': name,
                    'affected': report.trades_affected_by_vulnerability,
                    'pl_diff': report.total_pl_difference,
                    'accuracy': report.accuracy
                })

            # Show comparison
            comparison_text = "Preset Comparison:\n\n"
            comparison_text += f"{'Preset':<20} {'Affected':<10} {'P/L Diff':<15} {'Accuracy':<10}\n"
            comparison_text += "-" * 55 + "\n"

            for r in results:
                comparison_text += f"{r['name']:<20} {r['affected']:<10} ${r['pl_diff']:<14,.2f} {r['accuracy']*100:.1f}%\n"

            # Show in a dialog
            dialog = tk.Toplevel(self.root)
            dialog.title("Preset Comparison")
            dialog.geometry("500x300")

            text = tk.Text(dialog, font=('Consolas', 10))
            text.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)
            text.insert('1.0', comparison_text)
            text.configure(state='disabled')

        except Exception as e:
            messagebox.showerror("Error", f"Comparison failed: {str(e)}")
            traceback.print_exc()

    def _show_about(self):
        """Show about dialog."""
        messagebox.showinfo(
            "About",
            "Vulnerability Score Modeler & Optimizer\n\n"
            "A tool for analyzing and optimizing vulnerability score parameters "
            "for portfolio backtesting.\n\n"
            "Part of the BackTesting Framework"
        )


def main():
    """Main entry point."""
    root = tk.Tk()
    style = ttk.Style()
    style.theme_use('clam')

    app = VulnerabilityModelerGUI(root)
    root.mainloop()


if __name__ == "__main__":
    main()
