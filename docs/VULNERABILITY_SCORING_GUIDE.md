# Vulnerability Scoring Guide

Complete guide to understanding and configuring the Vulnerability Scoring system for portfolio optimization.

---

## Table of Contents

1. [Understanding Key Metrics](#understanding-key-metrics)
2. [Core Parameters](#core-parameters)
3. [Portfolio Configuration](#portfolio-configuration)
4. [Feature Configuration](#feature-configuration)
5. [Advanced Parameters](#advanced-parameters)
6. [Presets](#presets)
7. [Optimization Strategies](#optimization-strategies)

---

## Understanding Key Metrics

These metrics help you understand **how well your vulnerability algorithm performs**.

### 1. Accuracy
*"What % of swap decisions were correct?"*

**Definition**: The percentage of swapped positions where exiting early was the **right decision** (either beneficial or neutral compared to holding).

**Formula**:
```
Accuracy = (Beneficial Swaps + Neutral Swaps) / Total Swaps
```

**Example**:
```
You made 20 swap decisions:
‚îú‚îÄ 15 Beneficial (exiting early was better than holding)
‚îú‚îÄ 3 Neutral (no significant difference)
‚îî‚îÄ 2 Hurt (should have held, exiting early was worse)

Accuracy = (15 + 3) / 20 = 90%
```

**How to Interpret**:
- **>70% = EXCELLENT**: Your vulnerability algorithm is making good decisions
- **50-70% = GOOD**: Better than random, but room to improve
- **<50% = POOR**: You'd be better off NOT using vulnerability scoring
- **~50% = RANDOM**: Your parameters aren't helping

**What affects it**:
- ‚úÖ **Higher swap threshold** ‚Üí More accuracy (only swap very weak positions)
- ‚ùå **Lower swap threshold** ‚Üí Less accuracy (swap too aggressively)
- ‚úÖ **Good feature weights** ‚Üí Better predictions of which trades will fail

---

### 2. False Positive Rate
*"What % of swapped trades would have actually recovered?"*

**Definition**: The percentage of positions you closed that **would have been profitable** if you had held them to their natural exit.

**Formula**:
```
False Positive Rate = Hurt Swaps / Total Swaps
```

**Example**:
```
Trade AAPL:
- You held 5 days, it's down 2%, vulnerability score = 45
- New signal comes in, you swap AAPL out (exit early at -2%)
- Natural exit would have been: +8% (it recovered!)
- This is a FALSE POSITIVE - you killed a winner

Out of 20 swaps:
‚îú‚îÄ 2 False Positives (killed winners)
‚îî‚îÄ 18 True decisions

False Positive Rate = 2 / 20 = 10%
```

**Real-World Scenario**:
```
SCENARIO: Stock temporarily dips then recovers

Day 1: Buy NVDA at $100
Day 5: NVDA at $98 (-2%), score drops to 40
        ‚Üí Vulnerability says "SWAP!"
        ‚Üí You exit at $98 (small loss)
Day 10: NVDA hits $110 (natural exit)
        ‚Üí You would have made +10%!
        ‚Üí FALSE POSITIVE: Swapped a future winner
```

**How to Interpret**:
- **<10% = EXCELLENT**: Rarely killing winners
- **10-20% = ACCEPTABLE**: Some false alarms, but manageable
- **20-30% = CONCERNING**: Too many good trades being cut short
- **>30% = PROBLEMATIC**: You're exiting winners too often

**What affects it**:
- ‚úÖ **Higher immunity days** ‚Üí Protects positions longer, reduces false positives
- ‚úÖ **Higher swap threshold** ‚Üí Only swap truly weak positions
- ‚úÖ **Good momentum features** ‚Üí Better at distinguishing temporary dips from true failures
- ‚ùå **Aggressive parameters** ‚Üí More false positives

**Relationship with Accuracy**:
```
False Positive Rate ‚âà 1 - Accuracy

If Accuracy = 85%
Then False Positive Rate ‚âà 15%
```

---

### 3. Avg Days Early Exit
*"How many days before the natural exit do you typically swap?"*

**Definition**: The average number of days between when you closed a position (via swap) and when it would have naturally exited.

**Formula**:
```
Days Early = Natural Exit Date - Swap Date
Avg Days Early Exit = Sum(Days Early) / Number of Swaps
```

**Example**:
```
Trade MSFT:
- Entry: Jan 1
- Swapped: Jan 10 (vulnerability score too low)
- Natural Exit: Jan 25
- Days Early: 25 - 10 = 15 days

Trade GOOGL:
- Entry: Feb 1
- Swapped: Feb 8
- Natural Exit: Feb 18
- Days Early: 18 - 8 = 10 days

Avg Days Early Exit = (15 + 10) / 2 = 12.5 days
```

**How to Interpret**:

**SHORT Avg (1-5 days)**:
- ‚úÖ **Good**: Catching trades right before they exit naturally
- ‚úÖ Small opportunity cost - not much upside left anyway
- ‚ö†Ô∏è **Warning**: Might not be worth the complexity (minimal benefit)

**MEDIUM Avg (5-15 days)**:
- ‚úÖ **Optimal**: Good balance of risk management and opportunity
- Shows your algorithm is catching failing trades before they get worse
- Plenty of time to deploy capital to better opportunities

**LONG Avg (>15 days)**:
- ‚ö†Ô∏è **Risky**: Exiting very early in trade lifecycle
- Could be:
  - ‚úÖ Great if avoiding disasters (preventing big losses)
  - ‚ùå Bad if killing winners (high false positive rate)
- **CHECK**: Look at false positive rate to judge if this is good or bad

**Context Matters**:
```
SCENARIO A: Avg Days Early = 3, Accuracy = 60%
‚Üí VERDICT: NOT HELPFUL - exiting so close to natural exit that
           benefit is minimal, and still making mistakes

SCENARIO B: Avg Days Early = 12, Accuracy = 85%
‚Üí VERDICT: EXCELLENT - catching failures early with high accuracy

SCENARIO C: Avg Days Early = 20, False Positive Rate = 35%
‚Üí VERDICT: PROBLEMATIC - exiting way too early and killing winners
```

---

### 4. Avg P/L at Swap
*"What's your typical profit/loss when you decide to swap?"*

**Definition**: The average percentage profit or loss of positions **at the moment you swap them out**.

**Formula**:
```
P/L at Swap = ((Current Price - Entry Price) / Entry Price) √ó 100
Avg P/L at Swap = Sum(P/L at Swap) / Number of Swaps
```

**Example**:
```
Trade AAPL:
- Entry: $100
- Swapped at: $102 ‚Üí P/L at Swap = +2%
- Natural Exit would have been: $98 ‚Üí -2%
- RESULT: Good swap! Exited with small gain, avoided loss

Trade TSLA:
- Entry: $200
- Swapped at: $196 ‚Üí P/L at Swap = -2%
- Natural Exit would have been: $190 ‚Üí -5%
- RESULT: Good swap! Cut losses early

Trade MSFT:
- Entry: $300
- Swapped at: $294 ‚Üí P/L at Swap = -2%
- Natural Exit would have been: $330 ‚Üí +10%
- RESULT: Bad swap! Killed a winner

Avg P/L at Swap = (+2% + -2% + -2%) / 3 = -0.67%
```

**How to Interpret**:

**NEGATIVE Avg P/L at Swap** (e.g., -1% to -3%):
- ‚úÖ **Normal**: You're cutting losers early (expected behavior)
- ‚úÖ **Good risk management**: Not letting losses run
- ‚úÖ **CHECK**: Make sure you're actually **preventing bigger losses**
  - If natural exit would be -5% and you exit at -2%, that's great!
  - If natural exit would be +5% and you exit at -2%, that's terrible!

**NEAR ZERO Avg P/L at Swap** (e.g., -0.5% to +0.5%):
- ‚úÖ **Excellent**: Catching positions right at breakeven
- Shows you're not letting small losses become big losses
- Shows you're not exiting profitable positions prematurely

**POSITIVE Avg P/L at Swap** (e.g., +1% to +3%):
- ‚ö†Ô∏è **Warning**: You're often swapping out profitable positions
- Could be:
  - ‚úÖ Good: Taking profits before they reverse (if natural exit would be negative)
  - ‚ùå Bad: Exiting winners too early (if natural exit would be higher)
- **CHECK**: Look at false positive rate
  - High FP rate + Positive avg swap P/L = Killing winners (BAD)
  - Low FP rate + Positive avg swap P/L = Smart profit-taking (GOOD)

**Context Examples**:
```
SCENARIO A:
Avg P/L at Swap = -2.5%
Avg Natural Exit P/L (for swapped trades) = -8%
‚Üí VERDICT: EXCELLENT - cutting losses before they get worse

SCENARIO B:
Avg P/L at Swap = -2.5%
Avg Natural Exit P/L (for swapped trades) = +5%
‚Üí VERDICT: TERRIBLE - exiting positions in small drawdowns
           that would have recovered

SCENARIO C:
Avg P/L at Swap = +3%
False Positive Rate = 15%
‚Üí VERDICT: GOOD - taking profits before reversals,
           low false positive rate means it's working
```

---

### üéØ Putting Metrics Together

#### **Ideal Metrics Profile** ‚úÖ
```
Accuracy: 75-85%
False Positive Rate: 10-20%
Avg Days Early Exit: 5-15 days
Avg P/L at Swap: -1% to +1%

INTERPRETATION:
‚Üí Algorithm is making good decisions
‚Üí Catching failures early enough to make a difference
‚Üí Not killing too many winners
‚Üí Exiting near breakeven (good risk management)
```

#### **Warning Signs** ‚ö†Ô∏è
```
Accuracy: 45%
False Positive Rate: 55%
Avg Days Early Exit: 2 days
Avg P/L at Swap: -0.5%

INTERPRETATION:
‚Üí Making more bad decisions than good
‚Üí Exiting too close to natural exit (minimal benefit)
‚Üí Not worth the complexity - use simple FIFO instead
```

#### **Overly Aggressive** üö®
```
Accuracy: 60%
False Positive Rate: 40%
Avg Days Early Exit: 18 days
Avg P/L at Swap: +2%

INTERPRETATION:
‚Üí Swapping out positions way too early
‚Üí Killing winners frequently (40% false positives)
‚Üí Need to increase swap threshold and immunity days
```

#### **Too Conservative** üò¥
```
Accuracy: 95%
False Positive Rate: 5%
Avg Days Early Exit: 1 day
Avg P/L at Swap: -5%

INTERPRETATION:
‚Üí Only swapping completely dead positions
‚Üí Exiting so late there's minimal benefit
‚Üí Could be more aggressive - lower swap threshold
```

---

## Core Parameters

These are the fundamental parameters that control vulnerability scoring behavior.

### 1. **Immunity Days**

**Range**: 1-30 days
**Default**: 7 days
**Recommended**: 3-7 aggressive, 7-10 balanced, 10-14 conservative

**What it does**: Protects new positions from being swapped out for this many days after entry.

**Example**:
```
Immunity Days = 7

Day 1: Buy AAPL at $100 (score = 100, IMMUNE)
Day 3: New signal arrives, AAPL at $98 (score = 40)
       ‚Üí Cannot swap! Still immune
Day 8: New signal arrives, AAPL at $97 (score = 35)
       ‚Üí Can swap now! Immunity expired
```

**Why it matters**:
- Prevents swapping positions before they have time to work
- Reduces false positives (killing trades in temporary drawdowns)
- Too low (1-3): May exit good trades too early
- Too high (15+): Protects failing trades too long

**How to tune**:
- **High false positive rate?** ‚Üí Increase immunity days
- **Missing opportunities?** ‚Üí Decrease immunity days
- **Strategy needs time to work?** ‚Üí Increase immunity days

---

### 2. **Base Score**

**Range**: 50-200
**Default**: 100
**Recommended**: Keep at 100 unless you know what you're doing

**What it does**: The starting vulnerability score for all positions. Score decreases over time based on feature calculations.

**Example**:
```
Base Score = 100

All positions start at 100
Then features modify the score:
  - Days held: -5 points/day
  - Current P/L: +10 points (if profitable)
  - Momentum: +3 points (if trending up)

Final Score = 100 - 35 (days) + 10 (P/L) + 3 (momentum) = 78
```

**Why it matters**:
- Higher base score = positions take longer to become vulnerable
- Lower base score = positions become vulnerable faster
- **Usually left at 100** for consistency

**How to tune**:
- **Rarely needs adjustment** - use other parameters instead
- If you want all scores shifted up/down uniformly, adjust this
- Changing base score without changing swap threshold has no effect

---

### 3. **Swap Threshold**

**Range**: 10-90
**Default**: 50
**Recommended**: 30-40 conservative, 50-60 balanced, 60-80 aggressive

**What it does**: Positions with vulnerability score **below** this threshold can be swapped out for new signals.

**Example**:
```
Swap Threshold = 50

Position A: Score = 65 ‚Üí PROTECTED (cannot swap)
Position B: Score = 48 ‚Üí VULNERABLE (can swap)
Position C: Score = 30 ‚Üí VERY VULNERABLE (prime swap candidate)

When new signal arrives and portfolio is full:
‚Üí Position C would be swapped (lowest score < 50)
```

**Why it matters**:
- **Lower threshold (30-40)**: Harder to swap, more conservative
  - Only swap truly weak positions
  - Reduces false positives
  - May miss opportunities by holding losers too long

- **Higher threshold (60-80)**: Easier to swap, more aggressive
  - Swap more readily
  - More opportunities to capture new signals
  - Higher risk of false positives

**How to tune**:
- **High false positive rate?** ‚Üí Lower threshold (make swaps harder)
- **Missing good signals?** ‚Üí Raise threshold (make swaps easier)
- **Poor accuracy?** ‚Üí Lower threshold (only swap weak positions)

---

## Portfolio Configuration

### **Max Positions**

**Range**: 1-20
**Default**: 3
**Recommended**: Match your real trading capacity

**What it does**: Maximum number of simultaneous open positions in the portfolio.

**Example**:
```
Max Positions = 3

Current Portfolio:
1. AAPL (score = 75)
2. MSFT (score = 82)
3. GOOGL (score = 68)

New signal: AMZN
‚Üí Portfolio is FULL (3/3)
‚Üí Check vulnerability scores
‚Üí GOOGL has lowest score (68)
‚Üí If 68 < threshold: Swap GOOGL for AMZN
‚Üí If 68 >= threshold: Reject AMZN signal
```

**Why it matters**:
- **Lower capacity (1-3)**: More competition for positions
  - Higher value from good vulnerability scoring
  - More swaps occur
  - More rejection of signals

- **Higher capacity (5-10)**: Less competition
  - Less pressure on positions
  - Fewer swaps
  - More signals accepted

**How to tune**:
- **Match your real trading constraints** (capital, time, risk limits)
- **Test different values** to see impact on performance
- **Lower capacity** = More benefit from vulnerability optimization

---

## Feature Configuration

Features are individual metrics that contribute to the vulnerability score. Each feature has a **weight** that determines its impact.

### Available Features

#### 1. **Days Held** üïê

**Type**: Time-based
**Importance**: HIGH
**Recommended Weight**: -5.0
**Range**: -10.0 to 0.0

**What it measures**: Number of days since position was opened.

**How it works**:
```
Weight = -5.0

Day 1: Contribution = -5 √ó 1 = -5 points
Day 10: Contribution = -5 √ó 10 = -50 points
Day 20: Contribution = -5 √ó 20 = -100 points

‚Üí Older positions lose more points
‚Üí Become more vulnerable over time
```

**When to use**:
- ‚úÖ **Always recommended** - creates natural aging of positions
- Prevents holding stale positions indefinitely
- Forces turnover in portfolio

**How to tune**:
- **-1 to -3**: Gentle aging (conservative)
- **-4 to -6**: Moderate aging (balanced) ‚Üê Default
- **-7 to -10**: Aggressive aging (forces quick turnover)

**Disable when**: Never - this is a core feature

---

#### 2. **Current P/L %** üí∞

**Type**: Profitability
**Importance**: HIGH
**Recommended Weight**: +1.0
**Range**: 0.0 to 5.0

**What it measures**: Current profit/loss as percentage of entry price.

**How it works**:
```
Weight = 1.0

Entry: $100, Current: $110 ‚Üí P/L = +10%
Contribution = 1.0 √ó 10 = +10 points

Entry: $100, Current: $95 ‚Üí P/L = -5%
Contribution = 1.0 √ó (-5) = -5 points

‚Üí Profitable trades protected
‚Üí Losing trades become vulnerable
```

**When to use**:
- ‚úÖ **Always recommended** - protect winners, cull losers
- Key for "let winners run, cut losers early"

**How to tune**:
- **0.5-1.5**: Moderate protection of winners
- **2.0-3.0**: Strong protection of winners ‚Üê Use for trend-following
- **3.0-5.0**: Very strong protection (rarely swap winners)

**Disable when**: You want to ignore profitability (not recommended)

---

#### 3. **P/L Momentum (7d)** üìà

**Type**: Momentum
**Importance**: HIGH
**Recommended Weight**: +3.0
**Range**: 0.0 to 10.0

**What it measures**: Change in P/L over the last 7 days.

**How it works**:
```
Weight = 3.0

7 days ago: P/L was +5%
Today: P/L is +12%
Momentum = +12% - 5% = +7%
Contribution = 3.0 √ó 7 = +21 points

7 days ago: P/L was +8%
Today: P/L is +3%
Momentum = +3% - 8% = -5%
Contribution = 3.0 √ó (-5) = -15 points

‚Üí Upward momentum protected
‚Üí Downward momentum becomes vulnerable
```

**When to use**:
- ‚úÖ **Trend-following strategies** - keep positions with positive momentum
- ‚úÖ **Catching reversals** - exit positions losing momentum
- Key for distinguishing temporary dips from true failures

**How to tune**:
- **1.0-2.0**: Moderate momentum emphasis
- **3.0-5.0**: Strong momentum emphasis ‚Üê Default
- **6.0-10.0**: Very strong (heavily favor trending positions)

**Disable when**: Mean-reversion strategy (want to keep negative momentum)

---

#### 4. **P/L Momentum (14d)** üìä

**Type**: Momentum
**Importance**: MEDIUM
**Recommended Weight**: +2.0
**Range**: 0.0 to 10.0

**What it measures**: Change in P/L over the last 14 days (smoother than 7d).

**Similar to 7d momentum but**:
- Less reactive to short-term noise
- Better for medium-term trend identification
- Can be used together with 7d for multi-timeframe analysis

**When to use**:
- ‚úÖ When you want smoother momentum signals
- ‚úÖ For longer-term trend confirmation
- Can use BOTH 7d and 14d together

**How to tune**:
- Usually 50-70% of 7d momentum weight
- Example: 7d = 5.0, 14d = 3.0

**Disable when**: Using 7d momentum is sufficient (default)

---

#### 5. **Volatility (7d)** üìâ

**Type**: Risk
**Importance**: MEDIUM
**Recommended Weight**: +0.5
**Range**: -5.0 to 5.0

**What it measures**: 7-day rolling price volatility (annualized).

**How it works**:
```
Weight = -0.5 (penalize volatility)

Low volatility position: 15% annualized
Contribution = -0.5 √ó 15 = -7.5 points

High volatility position: 80% annualized
Contribution = -0.5 √ó 80 = -40 points

‚Üí Volatile positions become more vulnerable
‚Üí Stable positions protected
```

**When to use**:
- ‚úÖ **Risk management** - prefer stable positions
- ‚úÖ **Reduce drawdowns** - exit before volatility spikes lead to losses

**How to tune**:
- **Negative weight**: Penalize volatility (risk-averse)
  - -0.5 to -2.0: Moderate volatility penalty
  - -3.0 to -5.0: Strong penalty (strongly prefer stable trades)

- **Positive weight**: Keep volatile trades (unusual)
  - Only if volatility = opportunity in your strategy

**Disable when**: Volatility doesn't matter to your strategy (default)

---

#### 6. **Distance from High** üéØ

**Type**: Technical
**Importance**: MEDIUM
**Recommended Weight**: 0.0 (disabled)
**Range**: -5.0 to 5.0

**What it measures**: Percentage below the 52-week high.

**How it works**:
```
Weight = -2.0

52-week high: $120
Current price: $108
Distance = (108 - 120) / 120 = -10%

Contribution = -2.0 √ó 10 = -20 points

‚Üí Positions far from highs lose points
‚Üí Positions at/near highs protected
```

**When to use**:
- When relative strength matters
- To identify positions losing momentum vs the broader market
- To favor positions making new highs

**How to tune**:
- **Negative weight**: Penalize weakness (trades far from highs)
- Usually -1.0 to -3.0 if enabled

**Disable when**: Don't care about 52-week highs (default - usually disabled)

---

#### 7. **Max Favorable Excursion (MFE)** üìâ

**Type**: Risk
**Importance**: LOW
**Recommended Weight**: -1.0
**Range**: -5.0 to 0.0

**What it measures**: Drawdown from the best price achieved since entry.

**How it works**:
```
Weight = -1.0

Entry: $100
Best price: $115 (+15%)
Current: $108 (+8%)

MFE = (115 - 108) / 108 = 6.5% drawdown from peak

Contribution = -1.0 √ó 6.5 = -6.5 points

‚Üí Positions that peaked and fell back lose points
‚Üí Identifies "gave back gains"
```

**When to use**:
- ‚úÖ **Protect profits** - exit positions that peaked and reversed
- ‚úÖ **Prevent giving back gains** - lock in profits before reversals
- Identifies positions that may have "topped out"

**How to tune**:
- **-1.0 to -2.0**: Moderate penalty for giving back gains
- **-3.0 to -5.0**: Strong penalty (aggressively exit reversals)

**Disable when**: You want to hold through pullbacks (default - usually disabled)

---

#### 8. **Distance from Entry** üìç

**Type**: Profitability
**Importance**: LOW
**Recommended Weight**: 0.0 (disabled)
**Range**: -5.0 to 5.0

**What it measures**: Same as Current P/L % (percentage from entry price).

**Note**: This duplicates Current P/L % and is usually disabled.

**When to use**:
- Usually disabled (redundant with Current P/L %)
- Only enable if you want additional weight on entry reference

**Disable when**: Using Current P/L % (default - usually disabled)

---

#### 9. **Entropy (7d)** üé≤

**Type**: Technical
**Importance**: LOW
**Recommended Weight**: 0.0 (disabled)
**Range**: -5.0 to 5.0

**What it measures**: Price action "noise" - coefficient of variation over 7 days.

**How it works**:
- High entropy = choppy, erratic price action
- Low entropy = smooth, directional movement

**When to use**:
- To penalize choppy, directionless trades
- To favor smooth trending trades
- Advanced feature for specific strategies

**How to tune**:
- **Negative weight**: Penalize noisy price action
- Usually -1.0 to -3.0 if enabled

**Disable when**: Don't care about price noise (default - usually disabled)

---

## Advanced Parameters

These are per-feature parameters that provide fine-grained control.

### **Decay Point** ‚è±Ô∏è

**Range**: 1-60 days
**Default**: 14 days

**What it does**: For time-based features (like days_held), defines when the decay rate changes.

**Example**:
```
Days Held Feature:
Weight = -5.0
Decay Point = 14 days
Fast Decay Rate = 5.0
Slow Decay Rate = 1.0

Days 1-14: Loses 1.0 points/day (slow decay)
Days 15+: Loses 5.0 points/day (fast decay)

Day 10: -10 points
Day 20: -14 (first 14 days) + -30 (6 days fast) = -44 points
```

**When to adjust**:
- **Short trades (3-7 days)**: Lower decay point (7-10)
- **Medium trades (10-20 days)**: Default (14)
- **Long trades (20+ days)**: Higher decay point (21-30)

---

### **Fast Decay Rate** ‚ö°

**Range**: 0.5-20.0
**Default**: 5.0

**What it does**: Points lost per day for stagnant/underperforming trades.

**When to adjust**:
- **Conservative (1.0-3.0)**: Gentle culling of underperformers
- **Balanced (4.0-6.0)**: Moderate pressure ‚Üê Default
- **Aggressive (7.0-10.0+)**: Quick exit of stagnant positions

---

### **Slow Decay Rate** üêå

**Range**: 0.1-5.0
**Default**: 1.0

**What it does**: Points lost per day for performing trades.

**When to adjust**:
- **Let winners run (0.1-0.5)**: Very slow aging of winners
- **Balanced (0.5-1.5)**: Moderate aging ‚Üê Default
- **Force turnover (2.0-3.0)**: Winners still age, just slower than losers

---

### **Stagnation Threshold** üéØ

**Range**: 0.0-10.0 %
**Default**: 2.0%

**What it does**: P/L % below which a trade is considered "stagnant" and uses fast decay rate.

**Example**:
```
Stagnation Threshold = 2.0%

Trade A: P/L = +5% ‚Üí Performing ‚Üí Slow decay (1.0/day)
Trade B: P/L = +1% ‚Üí Stagnant ‚Üí Fast decay (5.0/day)
Trade C: P/L = -3% ‚Üí Stagnant ‚Üí Fast decay (5.0/day)
```

**When to adjust**:
- **Conservative (0-1%)**: Only clearly losing trades are stagnant
- **Balanced (2-3%)**: Default ‚Üê Moderate definition
- **Aggressive (4-5%+)**: Even small winners need to perform

---

## Presets

Pre-configured parameter sets for common strategies.

### **Default** (Balanced)

```
Immunity Days: 7
Base Score: 100
Swap Threshold: 50

Features:
- Days Held: -5.0 ‚úì
- Current P/L %: +1.0 ‚úì
- P/L Momentum 7d: +3.0 ‚úì
- Volatility 7d: +0.5 ‚úì
```

**Best for**: General-purpose trading, balanced approach

---

### **Conservative** (Protect Positions)

```
Immunity Days: 14
Base Score: 100
Swap Threshold: 30

Features:
- Days Held: -1.0 ‚úì
- Current P/L %: +2.0 ‚úì
- P/L Momentum 7d: +1.0 ‚úì
```

**Best for**:
- Lower turnover
- Longer holding periods
- Avoid false positives

---

### **Aggressive** (Quick Turnover)

```
Immunity Days: 3
Base Score: 100
Swap Threshold: 70

Features:
- Days Held: -3.0 ‚úì
- Current P/L %: +0.5 ‚úì
- P/L Momentum 7d: +5.0 ‚úì
- Volatility 7d: -0.5 ‚úì
- Max Favorable Excursion: -1.0 ‚úì
```

**Best for**:
- High turnover
- Capture new opportunities quickly
- Trend-following strategies

---

### **Momentum Focused**

```
Immunity Days: 7
Base Score: 100
Swap Threshold: 50

Features:
- Days Held: -1.0 ‚úì
- Current P/L %: +1.0 ‚úì
- P/L Momentum 7d: +5.0 ‚úì
- P/L Momentum 14d: +2.0 ‚úì
```

**Best for**:
- Trend-following
- Momentum strategies
- Riding strong moves

---

## Optimization Strategies

### üîß How to Use Metrics to Improve Parameters

#### **If Accuracy is Low (<60%)**:
1. **Increase swap threshold** (50 ‚Üí 60): Only swap weaker positions
2. **Adjust feature weights**: Review which features are misleading
3. **Increase immunity days**: Give trades more time to work

#### **If False Positive Rate is High (>25%)**:
1. **Reduce momentum features**: They might be too reactive to short-term dips
2. **Increase immunity days** (5 ‚Üí 10): Protect positions longer
3. **Focus on stagnation features**: Better at identifying truly dead trades

#### **If Avg Days Early is Too Short (<3 days)**:
1. **Lower swap threshold** (60 ‚Üí 50): Catch failures earlier
2. **Increase feature weights**: Make vulnerability score more sensitive
3. **Question**: Is vulnerability scoring worth it for such small time savings?

#### **If Avg P/L at Swap is Very Negative (<-3%)**:
1. **Lower swap threshold**: Exit failing positions sooner
2. **Increase fast decay rate**: Make scores drop faster for losers
3. **Add momentum features**: Catch downtrends earlier

---

### üéØ Optimization Workflow

1. **Start with Default preset**
2. **Run analysis** on your trade logs
3. **Review metrics**:
   - Accuracy
   - False Positive Rate
   - Avg Days Early Exit
   - Avg P/L at Swap
4. **Adjust parameters** based on metrics
5. **Re-run analysis**
6. **Compare Portfolio P/L improvement** (FIFO vs Vulnerability)
7. **Iterate** until optimal

---

### üìä Portfolio P/L Comparison

The ultimate metric is **Portfolio P/L Improvement**:

```
FIFO Portfolio: $45,230
Vulnerability Portfolio: $58,450
Improvement: +$13,220 (+29.2%)

‚úì Vulnerability scoring is adding value!
```

**Interpretation**:
- **Positive improvement (>5%)**: Algorithm is working well
- **Small improvement (0-5%)**: Marginal benefit, may not be worth complexity
- **Negative improvement**: FIFO is better, adjust parameters or disable

---

## Quick Reference

### Core Parameters Quick Guide

| Parameter | Conservative | Balanced | Aggressive |
|-----------|-------------|----------|------------|
| **Immunity Days** | 10-14 | 7-10 | 3-5 |
| **Swap Threshold** | 30-40 | 50-60 | 60-80 |
| **Days Held Weight** | -1 to -3 | -4 to -6 | -7 to -10 |
| **Current P/L Weight** | 2-3 | 1-2 | 0.5-1 |
| **Momentum Weight** | 1-2 | 3-5 | 5-10 |

### Feature Importance Rankings

| Rank | Feature | Use Case |
|------|---------|----------|
| ü•á | **Days Held** | Always use - creates natural aging |
| ü•á | **Current P/L %** | Always use - protect winners |
| ü•à | **P/L Momentum 7d** | Trend-following, catching reversals |
| ü•â | **Volatility 7d** | Risk management |
| ü•â | **P/L Momentum 14d** | Medium-term trend confirmation |
| 4Ô∏è‚É£ | **Max Favorable Excursion** | Protect profits, exit reversals |
| 5Ô∏è‚É£ | **Distance from High** | Relative strength filtering |
| 6Ô∏è‚É£ | **Entropy 7d** | Advanced - filter choppy trades |

---

## P/L Calculation Details

### How Swap P/L is Determined

**Data Sources**:
- **Entry Price**: From trade log
- **Entry Date**: From trade log
- **Swap Date**: When new signal arrives and swap occurs
- **Current Price at Swap**: From raw CSV data (close price on swap date)
- **Natural Exit Date**: From trade log
- **Natural Exit Price**: From trade log
- **Quantity**: From trade log

**Calculation**:
```python
# P/L at swap (using raw data)
pl_at_swap_dollars = (current_price - entry_price) √ó quantity

# Natural P/L (from trade log)
natural_pl_dollars = (natural_exit_price - entry_price) √ó quantity

# Impact of swap decision
pl_difference = pl_at_swap_dollars - natural_pl_dollars
```

**Example**:
```
AAPL Trade:
Entry: Jan 1 @ $180.00 (100 shares)
Swap: Feb 10 @ $182.50 (from raw CSV)
Natural Exit: Feb 25 @ $178.00 (from trade log)

P/L at Swap = ($182.50 - $180.00) √ó 100 = +$250.00
Natural P/L = ($178.00 - $180.00) √ó 100 = -$200.00
Swap Impact = $250.00 - (-$200.00) = +$450.00

‚úì BENEFICIAL SWAP!
```

**Why This is Accurate**:
- Uses real market prices from historical data
- No interpolation or estimates
- Same data that was available during backtest
- Realistic execution assumption (close price)

---

## Additional Resources

- **PORTFOLIO_MODE.md**: How portfolio mode works in the main backtesting framework
- **USER_GUIDE.md**: General usage guide
- **CONFIGURATION.md**: All configuration options
- **OPTIMIZATION.md**: Parameter optimization guide

---

*Last updated: 2024-12-21*
