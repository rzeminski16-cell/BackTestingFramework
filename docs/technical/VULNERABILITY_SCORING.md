# Vulnerability Scoring Reference

Technical reference for the Vulnerability Scoring system used in portfolio capital allocation.

## Overview

Vulnerability Scoring evaluates open positions to determine which are "weak" and can be closed to make room for new signals. Each position gets a score from 0-100:

- **100** = Strong, protected
- **0** = Weak, can be swapped

When a new signal arrives and the portfolio is at capacity, the system:
1. Calculates vulnerability scores for all positions
2. Finds the weakest position
3. If weakest score < threshold, closes it for the new signal
4. Otherwise, rejects the new signal

---

## Key Metrics

### Accuracy

*"What % of swap decisions were correct?"*

```
Accuracy = (Beneficial Swaps + Neutral Swaps) / Total Swaps
```

| Value | Interpretation |
|-------|----------------|
| >70% | Excellent |
| 50-70% | Good |
| <50% | Poor - worse than not using vulnerability scoring |

### False Positive Rate

*"What % of swapped trades would have recovered?"*

```
False Positive Rate = Hurt Swaps / Total Swaps
```

| Value | Interpretation |
|-------|----------------|
| <10% | Excellent |
| 10-20% | Acceptable |
| 20-30% | Concerning |
| >30% | Problematic |

### Avg Days Early Exit

*"How many days before natural exit do you swap?"*

| Value | Interpretation |
|-------|----------------|
| 1-5 days | Short - minimal benefit |
| 5-15 days | Optimal - good balance |
| >15 days | Long - check false positive rate |

### Avg P/L at Swap

*"What's your typical P/L when swapping?"*

| Value | Interpretation |
|-------|----------------|
| Negative | Normal - cutting losers early |
| Near zero | Excellent - catching at breakeven |
| Positive | Warning - may be killing winners |

---

## Core Parameters

### Immunity Days

**Range:** 1-30 days
**Default:** 7 days

Protects new positions from being swapped for this many days after entry.

```
Immunity Days = 7

Day 1: Buy AAPL (score = 100, IMMUNE)
Day 3: New signal, AAPL at -2% (score = 40)
       → Cannot swap! Still immune
Day 8: New signal, AAPL at -3% (score = 35)
       → Can swap now! Immunity expired
```

| Value | Use Case |
|-------|----------|
| 1-3 | Aggressive - quick turnover |
| 7-10 | Balanced |
| 10-14 | Conservative - protect positions |

### Base Score

**Range:** 50-200
**Default:** 100

Starting score for all positions. Usually left at 100.

### Swap Threshold

**Range:** 10-90
**Default:** 50

Positions with score below threshold can be swapped.

```
Swap Threshold = 50

Position A: Score = 65 → PROTECTED
Position B: Score = 48 → VULNERABLE
Position C: Score = 30 → VERY VULNERABLE
```

| Value | Behavior |
|-------|----------|
| 30-40 | Conservative - only swap very weak |
| 50-60 | Balanced |
| 60-80 | Aggressive - swap more readily |

---

## Features

### Days Held

**Type:** Time-based
**Importance:** HIGH
**Recommended Weight:** -5.0

Older positions lose more points, becoming more vulnerable.

```
Weight = -5.0

Day 1:  -5 points
Day 10: -50 points
Day 20: -100 points
```

### Current P/L %

**Type:** Profitability
**Importance:** HIGH
**Recommended Weight:** +1.0

Profitable trades are protected, losing trades become vulnerable.

```
Weight = 1.0

P/L = +10%: +10 points
P/L = -5%:  -5 points
```

### P/L Momentum (7d)

**Type:** Momentum
**Importance:** HIGH
**Recommended Weight:** +3.0

Change in P/L over last 7 days. Upward momentum protected, downward vulnerable.

```
Weight = 3.0

7 days ago: P/L = +5%
Today: P/L = +12%
Momentum = +7%
Contribution = +21 points
```

### P/L Momentum (14d)

**Type:** Momentum
**Importance:** MEDIUM
**Recommended Weight:** +2.0

Smoother than 7d, better for medium-term trends. Can use both together.

### Volatility (7d)

**Type:** Risk
**Importance:** MEDIUM
**Recommended Weight:** -0.5

Penalize high volatility positions.

```
Weight = -0.5

Low volatility (15%): -7.5 points
High volatility (80%): -40 points
```

### Distance from High

**Type:** Technical
**Importance:** MEDIUM
**Recommended Weight:** 0.0 (usually disabled)

Percentage below 52-week high. Penalizes relative weakness.

### Max Favorable Excursion (MFE)

**Type:** Risk
**Importance:** LOW
**Recommended Weight:** -1.0

Drawdown from best price since entry. Identifies "gave back gains."

### Entropy (7d)

**Type:** Technical
**Importance:** LOW
**Recommended Weight:** 0.0 (usually disabled)

Price action noise. Penalizes choppy, directionless trades.

---

## Advanced Parameters

### Decay Point

**Range:** 1-60 days
**Default:** 14 days

For time-based features, when decay rate changes.

```
Days Held Feature:
Decay Point = 14 days
Slow Decay = 1.0/day
Fast Decay = 5.0/day

Days 1-14:  Slow decay (1.0 points/day)
Days 15+:   Fast decay (5.0 points/day)
```

### Stagnation Threshold

**Range:** 0.0-10.0%
**Default:** 2.0%

P/L % below which a trade uses fast decay.

```
Stagnation Threshold = 2.0%

P/L = +5% → Performing → Slow decay
P/L = +1% → Stagnant → Fast decay
P/L = -3% → Losing → Fast decay
```

---

## Simple vs Advanced Mode

### Simple Mode

Constant weight applied:

```
Feature contribution = Feature value × Weight

Days Held (Weight = -5.0):
Day 10: 10 × (-5.0) = -50 points
```

### Advanced Mode

Dynamic weight based on performance:

```
Days Held (Decay Point = 14):
Days 1-14: Uses slow decay rate
Days 15+:  Uses fast decay rate

Day 10 (slow): -10 points
Day 20 (fast): -100 points
```

---

## Presets

### Default (Balanced)

```json
{
  "immunity_days": 7,
  "base_score": 100,
  "swap_threshold": 50,
  "features": {
    "days_held": { "weight": -5.0 },
    "current_pl_pct": { "weight": 1.0 },
    "pl_momentum_7d": { "weight": 3.0 },
    "volatility_7d": { "weight": 0.5 }
  }
}
```

### Conservative

```json
{
  "immunity_days": 14,
  "swap_threshold": 30,
  "features": {
    "days_held": { "weight": -1.0 },
    "current_pl_pct": { "weight": 2.0 },
    "pl_momentum_7d": { "weight": 1.0 }
  }
}
```

### Aggressive

```json
{
  "immunity_days": 3,
  "swap_threshold": 70,
  "features": {
    "days_held": { "weight": -3.0 },
    "current_pl_pct": { "weight": 0.5 },
    "pl_momentum_7d": { "weight": 5.0 },
    "volatility_7d": { "weight": -0.5 },
    "mfe": { "weight": -1.0 }
  }
}
```

### Momentum Focused

```json
{
  "immunity_days": 7,
  "swap_threshold": 50,
  "features": {
    "days_held": { "weight": -1.0 },
    "current_pl_pct": { "weight": 1.0 },
    "pl_momentum_7d": { "weight": 5.0 },
    "pl_momentum_14d": { "weight": 2.0 }
  }
}
```

---

## Configuration Files

### Location

`config/vulnerability_presets/`

### Format

```json
{
  "name": "Default",
  "description": "Balanced approach",
  "parameters": {
    "immunity_days": 7,
    "base_score": 100,
    "swap_threshold": 50
  },
  "features": {
    "days_held": {
      "enabled": true,
      "weight": -5.0,
      "use_advanced_params": false
    },
    "current_pl_pct": {
      "enabled": true,
      "weight": 1.0
    },
    "pl_momentum_7d": {
      "enabled": true,
      "weight": 3.0
    }
  }
}
```

---

## Usage

### In Portfolio Config

```python
from Classes.Config.config import (
    PortfolioConfig,
    CapitalContentionConfig,
    CapitalContentionMode
)

config = PortfolioConfig(
    initial_capital=100000.0,
    max_positions=3,
    capital_contention=CapitalContentionConfig(
        mode=CapitalContentionMode.VULNERABILITY_SCORE,
        swap_threshold=50.0
    )
)
```

### GUI

```bash
python vulnerability_gui.py
```

Features:
- Load backtest results
- Configure parameters
- Simulate swaps
- Visualize trade lifecycles
- Compare FIFO vs Vulnerability

---

## Optimization

### Tuning Based on Metrics

**Low Accuracy (<60%):**
- Increase swap threshold (50 → 60)
- Increase immunity days
- Review feature weights

**High False Positive Rate (>25%):**
- Reduce momentum weights
- Increase immunity days (5 → 10)
- Focus on stagnation features

**Short Avg Days Early (<3):**
- Lower swap threshold (60 → 50)
- Increase feature weights
- Question if vulnerability scoring is worthwhile

**Very Negative Avg P/L at Swap (<-3%):**
- Lower swap threshold (exit sooner)
- Increase fast decay rate
- Add momentum features

### Workflow

1. Start with Default preset
2. Run analysis on trade logs
3. Review metrics
4. Adjust parameters
5. Re-run analysis
6. Compare Portfolio P/L (FIFO vs Vulnerability)
7. Iterate until optimal

### Success Metric

```
FIFO Portfolio: $45,230
Vulnerability Portfolio: $58,450
Improvement: +$13,220 (+29.2%)
```

- Positive improvement (>5%): Working well
- Small improvement (0-5%): Marginal benefit
- Negative improvement: FIFO is better

---

## Quick Reference

### Parameter Guide

| Parameter | Conservative | Balanced | Aggressive |
|-----------|-------------|----------|------------|
| Immunity Days | 10-14 | 7-10 | 3-5 |
| Swap Threshold | 30-40 | 50-60 | 60-80 |
| Days Held Weight | -1 to -3 | -4 to -6 | -7 to -10 |
| Current P/L Weight | 2-3 | 1-2 | 0.5-1 |
| Momentum Weight | 1-2 | 3-5 | 5-10 |

### Feature Rankings

| Rank | Feature | Always Use? |
|------|---------|-------------|
| 1 | Days Held | Yes |
| 1 | Current P/L % | Yes |
| 2 | P/L Momentum 7d | For trend-following |
| 3 | Volatility 7d | For risk management |
| 3 | P/L Momentum 14d | For medium-term |
| 4 | MFE | For profit protection |
| 5 | Distance from High | Rarely |
| 6 | Entropy 7d | Advanced use only |

### Ideal Metrics Profile

```
Accuracy: 75-85%
False Positive Rate: 10-20%
Avg Days Early Exit: 5-15 days
Avg P/L at Swap: -1% to +1%
```
