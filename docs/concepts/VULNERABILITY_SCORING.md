# Vulnerability Scoring

Vulnerability scoring enables intelligent capital allocation when multiple trading signals compete for limited resources.

---

## The Capital Contention Problem

In portfolio mode, a common situation arises:

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    THE CAPITAL CONTENTION PROBLEM                           │
│                                                                             │
│   Situation:                                                                │
│   ├── max_positions: 3                                                      │
│   ├── Currently holding: AAPL, MSFT, GOOGL (all 3 slots filled)           │
│   └── New BUY signal: NVDA                                                  │
│                                                                             │
│   Problem:                                                                  │
│   ├── No available position slots                                          │
│   ├── But NVDA signal might be better than current positions              │
│   └── What should we do?                                                    │
│                                                                             │
│   Options:                                                                  │
│   ├── DEFAULT: Skip NVDA signal (first-come-first-served)                  │
│   └── VULNERABILITY_SCORE: Evaluate and potentially swap                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## How Vulnerability Scoring Works

The system assigns a score to each position and pending signal, then makes allocation decisions based on these scores.

### Scoring Concept

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     VULNERABILITY SCORE CONCEPT                             │
│                                                                             │
│   Higher Score = Stronger Position (keep it)                               │
│   Lower Score = Weaker Position (vulnerable to replacement)                │
│                                                                             │
│   Score Factors:                                                            │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                                                                     │  │
│   │   POSITIVE FACTORS (increase score):                               │  │
│   │   ├── Current profitability (unrealized P/L)                      │  │
│   │   ├── Profit momentum (trending more profitable)                  │  │
│   │   └── Favorable price vs stop loss distance                       │  │
│   │                                                                     │  │
│   │   NEGATIVE FACTORS (decrease score):                               │  │
│   │   ├── Position age (older = more vulnerable)                      │  │
│   │   ├── Proximity to stop loss                                      │  │
│   │   └── Declining profit trajectory                                 │  │
│   │                                                                     │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Score Calculation

The vulnerability score combines multiple factors:

```
Score = w1 × profitability_score
      + w2 × age_score
      + w3 × risk_score
      + w4 × momentum_score

Where weights (w1, w2, w3, w4) are configurable
```

#### Profitability Score

Based on current unrealized profit/loss:

```
Profitability Score:

    Score
    1.0  │  ─────────────────────────
         │                          ╱
    0.5  │                   ╱─────
         │            ╱─────
    0.0  │─────╲─────
         │       ╲
   -0.5  │        ╲─────────────────
         └─────────────────────────────
            -10%  -5%   0%   +5%  +10%  (P/L %)

    Profitable positions score higher
    Losing positions score lower
```

#### Age Score

Older positions become more vulnerable:

```
Age Score:

    Score
    1.0  │──────╲
         │       ╲
    0.5  │        ╲────────
         │                 ╲
    0.0  │                  ╲──────────
         └─────────────────────────────
             0    5    10   15   20  (days held)

    Newer positions score higher
    Older positions score lower (time decay)
```

#### Risk Score

Distance from stop loss:

```
Risk Score:

    Score
    1.0  │                    ─────────
         │                ╱───
    0.5  │          ╱─────
         │    ╱─────
    0.0  │────
         └─────────────────────────────
             0%   5%   10%  15%  20%  (distance from stop)

    Far from stop = higher score (safer)
    Close to stop = lower score (risky)
```

---

## The Swap Decision

When a new signal arrives and positions are full:

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       SWAP DECISION PROCESS                                 │
│                                                                             │
│   Current Positions:                  New Signal:                          │
│   ├── AAPL: Score 0.72               ├── NVDA: Score 0.65                  │
│   ├── MSFT: Score 0.58                                                     │
│   └── GOOGL: Score 0.41 ◄── Lowest                                         │
│                                                                             │
│   Decision:                                                                 │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                                                                     │  │
│   │   Compare: NVDA (0.65) vs GOOGL (0.41)                            │  │
│   │                                                                     │  │
│   │   NVDA score > GOOGL score + threshold?                           │  │
│   │   0.65 > 0.41 + 0.10 = 0.51?                                      │  │
│   │   Yes → SWAP: Close GOOGL, Open NVDA                              │  │
│   │                                                                     │  │
│   │   (Threshold prevents excessive churning)                         │  │
│   │                                                                     │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│   Result:                                                                   │
│   ├── AAPL: Score 0.72  (kept)                                             │
│   ├── MSFT: Score 0.58  (kept)                                             │
│   └── NVDA: Score 0.65  (new)                                              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Configuration

### Scoring Weights

Control the importance of each factor:

| Weight | Factor | Default | Effect of Increasing |
|--------|--------|---------|---------------------|
| `profitability_weight` | Current P/L | 0.4 | More emphasis on winners |
| `age_weight` | Position age | 0.2 | Faster turnover |
| `risk_weight` | Stop distance | 0.2 | Prefer safer positions |
| `momentum_weight` | P/L trend | 0.2 | Chase momentum |

### Thresholds

Prevent unnecessary trading:

| Setting | Purpose | Default |
|---------|---------|---------|
| `swap_threshold` | Minimum score difference to swap | 0.10 |
| `min_hold_period` | Days before position can be swapped | 1 |

### Presets

Pre-configured weight combinations in `config/vulnerability_presets/`:

```
base.json (Conservative):
├── profitability_weight: 0.4
├── age_weight: 0.2
├── risk_weight: 0.3
└── momentum_weight: 0.1

optimised.json (Aggressive):
├── profitability_weight: 0.35
├── age_weight: 0.25
├── risk_weight: 0.2
└── momentum_weight: 0.2
```

---

## Impact on Performance

### With DEFAULT Mode (No Scoring)

```
Capital Contention Events: 47
├── Signals skipped: 47
├── Missed opportunities: Unknown
└── Positions held to completion: 100%

Characteristics:
• Simple first-come-first-served
• No position churn
• May miss better opportunities
• Lower transaction costs
```

### With VULNERABILITY_SCORE Mode

```
Capital Contention Events: 47
├── Swaps executed: 18
├── Signals skipped: 29
└── Early exits due to swap: 18

Characteristics:
• Intelligent capital allocation
• Position churn increases
• Captures better opportunities
• Higher transaction costs
```

### Comparison

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                  MODE COMPARISON RESULTS                                    │
│                                                                             │
│                           DEFAULT         VULNERABILITY_SCORE               │
│   Total Return:            +15.2%              +18.7%                       │
│   Sharpe Ratio:             1.12                1.28                        │
│   Max Drawdown:            -12.3%              -11.8%                       │
│   Total Trades:              85                  103                        │
│   Avg Hold Period:         8.2 days            6.9 days                     │
│   Commission Cost:          $850               $1,030                       │
│                                                                             │
│   Net Impact: +3.5% return improvement, +0.16 Sharpe improvement          │
│   Cost: 21% more trades, $180 more commission                              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Tuning the Scorer

### Using the Vulnerability Modeler GUI

```bash
python ctk_vulnerability_gui.py
```

The GUI provides:
1. **Load Results**: Import portfolio backtest results
2. **View Scores**: See historical scores for all positions
3. **Adjust Weights**: Modify scoring factors interactively
4. **Visualize Impact**: See how weight changes affect allocation
5. **Save Presets**: Export optimized configurations

### Tuning Process

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     TUNING WORKFLOW                                         │
│                                                                             │
│   1. Run portfolio backtest with VULNERABILITY_SCORE mode                  │
│      └── Use default weights initially                                     │
│                                                                             │
│   2. Load results into Vulnerability Modeler                               │
│      └── Examine swap decisions                                            │
│                                                                             │
│   3. Identify problematic swaps                                            │
│      ├── Swaps that hurt performance                                       │
│      ├── Missed swaps that would have helped                               │
│      └── Excessive churning periods                                        │
│                                                                             │
│   4. Adjust weights based on observations                                  │
│      ├── Too many swaps? Increase swap_threshold                          │
│      ├── Holding losers too long? Increase profitability_weight           │
│      └── Cutting winners early? Decrease age_weight                       │
│                                                                             │
│   5. Re-run backtest with new weights                                      │
│      └── Compare to baseline                                               │
│                                                                             │
│   6. Iterate until satisfied                                               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## When to Use Vulnerability Scoring

### Good Use Cases

| Situation | Why Scoring Helps |
|-----------|-------------------|
| Many signals, few slots | Prioritizes best opportunities |
| Dynamic market conditions | Adapts to changing situations |
| Trend-following strategies | Cuts losers, keeps winners |
| Active trading style | Embraces position turnover |

### Poor Use Cases

| Situation | Why Scoring May Hurt |
|-----------|---------------------|
| Few signals relative to slots | Rarely triggers, adds complexity |
| High commission costs | Churn erodes profits |
| Long-term holding strategies | Disrupts intended holding periods |
| Mean-reversion strategies | May exit before reversion |

---

## Implementation Details

### Score Update Frequency

Scores are recalculated daily for all positions:
- At market close
- Before processing new signals
- Using end-of-day prices

### Swap Execution

When a swap occurs:
1. Weakest position closed at current close price
2. Commission deducted
3. New position opened at current close price
4. Commission deducted
5. Net capital transfer completed

### Tie Breaking

If multiple positions have equal scores:
- Oldest position is considered weakest
- If still tied, alphabetical order (deterministic)

---

## Related Documentation

- [Portfolio Mode](PORTFOLIO_MODE.md) — Multi-security backtesting
- [Applications: Vulnerability Modeler](../applications/ANALYSIS_TOOLS.md) — Using the GUI
- [Configuration: Vulnerability](../reference/CONFIGURATION.md#vulnerability-scoring) — All settings
