"""
Vulnerability Score Modeler & Optimizer GUI (CustomTkinter).

A modern graphical interface for analyzing and optimizing vulnerability score parameters.

Features:
- Dark/blue theme matching data collection GUI
- Panel-based layout with tabs for results
- Interactive parameter configuration
- Plotly charts for visualization
- Portfolio simulation and analysis
"""

import customtkinter as ctk
from pathlib import Path
from datetime import datetime
from typing import Dict, List, Any, Optional
import json
import threading
import queue
import traceback

from Classes.GUI.ctk_theme import Theme, Colors, Fonts, Sizes, ProgressPanel, show_error, show_info, ask_yes_no

from Classes.VulnerabilityScorer.loader import BacktestTradeLoader, DataAvailabilityReport
from Classes.VulnerabilityScorer.scoring import (
    VulnerabilityScoreParams,
    VulnerabilityScoringEngine,
    VULNERABILITY_SCORE_PRESETS,
    PresetManager
)
from Classes.VulnerabilityScorer.analyzer import (
    VulnerabilityAnalyzer,
    VulnerabilityAnalysisReport
)
from Classes.VulnerabilityScorer.features import AVAILABLE_FEATURES, FeatureWeight, FeatureError
from Classes.Config.capital_contention import (
    EnhancedVulnerabilityConfig,
    ENHANCED_FEATURE_DEFINITIONS,
    FEATURE_PARAMETER_DEFINITIONS,
    VULNERABILITY_CORE_PARAM_DEFINITIONS
)
from Classes.Data.data_loader import DataLoader


class CTkVulnerabilityModelerGUI:
    """Main GUI application for Vulnerability Score Modeler using CustomTkinter."""

    def __init__(self):
        """Initialize the GUI."""
        Theme.setup()

        self.root = ctk.CTk()
        self.root.title("Vulnerability Score Modeler & Optimizer")
        self.root.geometry("1500x950")
        self.root.minsize(1300, 800)
        self.root.configure(fg_color=Colors.BG_DARK)

        # Initialize data
        self.data_directory = Path('raw_data')
        self.data_loader: Optional[BacktestTradeLoader] = None
        self.trades: List[Dict[str, Any]] = []
        self.price_data: Dict[str, Any] = {}
        self.current_report: Optional[VulnerabilityAnalysisReport] = None

        # Parameters
        self.params = VulnerabilityScoreParams()
        self.feature_vars: Dict[str, Dict[str, ctk.Variable]] = {}

        # Preset Manager
        self.preset_manager = PresetManager()

        # Portfolio results
        self.portfolio_fifo_result = None
        self.portfolio_vuln_result = None

        # Create UI
        self._create_menu()
        self._create_main_layout()
        self._load_presets()

    def run(self):
        """Start the application."""
        self.root.mainloop()

    def _create_menu(self):
        """Create menu bar (using CTk frame-based approach)."""
        menu_frame = Theme.create_frame(self.root)
        menu_frame.pack(fill="x", padx=Sizes.PAD_S, pady=(Sizes.PAD_S, 0))

        # File menu button
        self.file_menu_btn = Theme.create_button(
            menu_frame, "File",
            command=self._show_file_menu,
            style="ghost", width=60, height=28
        )
        self.file_menu_btn.pack(side="left", padx=2)

        # Presets menu button
        self.presets_menu_btn = Theme.create_button(
            menu_frame, "Presets",
            command=self._show_presets_menu,
            style="ghost", width=70, height=28
        )
        self.presets_menu_btn.pack(side="left", padx=2)

        # Tools menu button
        self.tools_menu_btn = Theme.create_button(
            menu_frame, "Tools",
            command=self._show_tools_menu,
            style="ghost", width=60, height=28
        )
        self.tools_menu_btn.pack(side="left", padx=2)

    def _show_file_menu(self):
        """Show file menu dropdown."""
        menu = CTkDropdownMenu(self.root, self.file_menu_btn, [
            ("Load Trade Log...", self._load_trade_log),
            ("Load Multiple Trade Logs...", self._load_multiple_trade_logs),
            ("Set Data Directory...", self._set_data_directory),
            None,  # Separator
            ("Export Report...", self._export_report),
            ("Export Parameters...", self._export_params),
            ("Import Parameters...", self._import_params),
        ])
        menu.show()

    def _show_presets_menu(self):
        """Show presets menu dropdown."""
        menu = CTkDropdownMenu(self.root, self.presets_menu_btn, [
            ("Save Current as Preset...", self._save_current_preset),
            ("Manage Presets...", self._manage_presets),
        ])
        menu.show()

    def _show_tools_menu(self):
        """Show tools menu dropdown."""
        menu = CTkDropdownMenu(self.root, self.tools_menu_btn, [
            ("Find Optimal Parameters...", self._find_optimal),
            ("Compare Presets", self._compare_presets),
            None,
            ("Sensitivity Analysis...", self._run_sensitivity_analysis),
            ("Walk-Forward Validation...", self._run_walk_forward),
        ])
        menu.show()

    def _create_main_layout(self):
        """Create main layout with panels."""
        # Main container
        main_frame = Theme.create_frame(self.root)
        main_frame.pack(fill="both", expand=True, padx=Sizes.PAD_S, pady=Sizes.PAD_S)
        main_frame.grid_columnconfigure(0, weight=1)
        main_frame.grid_columnconfigure(1, weight=3)
        main_frame.grid_rowconfigure(0, weight=1)

        # Left panel - Configuration
        left_frame = Theme.create_frame(main_frame)
        left_frame.grid(row=0, column=0, sticky="nsew", padx=(0, Sizes.PAD_S))
        self._create_config_panel(left_frame)

        # Right panel - Results and Charts
        right_frame = Theme.create_frame(main_frame)
        right_frame.grid(row=0, column=1, sticky="nsew")
        self._create_results_panel(right_frame)

    def _create_config_panel(self, parent: ctk.CTkFrame):
        """Create the configuration panel."""
        # Data Loading Section
        data_card = Theme.create_card(parent)
        data_card.pack(fill="x", pady=(0, Sizes.PAD_M))

        data_content = Theme.create_frame(data_card)
        data_content.pack(fill="x", padx=Sizes.PAD_M, pady=Sizes.PAD_M)

        Theme.create_header(data_content, "Data", size="s").pack(anchor="w", pady=(0, Sizes.PAD_S))

        Theme.create_button(
            data_content, "Load Trade Log",
            command=self._load_trade_log,
            width=200
        ).pack(fill="x", pady=Sizes.PAD_XS)

        self.data_status_var = ctk.StringVar(value="No data loaded")
        Theme.create_label(
            data_content, "",
            textvariable=self.data_status_var,
            text_color=Colors.TEXT_SECONDARY
        ).pack(anchor="w", pady=Sizes.PAD_S)

        # Preset Selection
        preset_card = Theme.create_card(parent)
        preset_card.pack(fill="x", pady=(0, Sizes.PAD_M))

        preset_content = Theme.create_frame(preset_card)
        preset_content.pack(fill="x", padx=Sizes.PAD_M, pady=Sizes.PAD_M)

        Theme.create_header(preset_content, "Preset", size="s").pack(anchor="w", pady=(0, Sizes.PAD_S))

        self.preset_var = ctk.StringVar(value="default")
        self.preset_combo = Theme.create_combobox(
            preset_content,
            values=[],
            variable=self.preset_var,
            command=self._on_preset_selected,
            width=250
        )
        self.preset_combo.pack(fill="x")

        # Parameters Section (scrollable)
        params_card = Theme.create_card(parent)
        params_card.pack(fill="both", expand=True, pady=(0, Sizes.PAD_M))

        params_header = Theme.create_frame(params_card)
        params_header.pack(fill="x", padx=Sizes.PAD_M, pady=(Sizes.PAD_M, 0))
        Theme.create_header(params_header, "Parameters", size="s").pack(anchor="w")

        # Scrollable parameters area
        self.params_scroll = ctk.CTkScrollableFrame(
            params_card,
            fg_color="transparent"
        )
        self.params_scroll.pack(fill="both", expand=True, padx=Sizes.PAD_M, pady=Sizes.PAD_M)

        self._create_parameter_widgets()

        # Run Button
        run_card = Theme.create_card(parent)
        run_card.pack(fill="x")

        run_content = Theme.create_frame(run_card)
        run_content.pack(fill="x", padx=Sizes.PAD_M, pady=Sizes.PAD_M)

        Theme.create_button(
            run_content, "Run Analysis",
            command=self._run_analysis,
            style="success",
            height=40
        ).pack(fill="x")

    def _create_parameter_widgets(self):
        """Create parameter input widgets."""
        frame = self.params_scroll

        # Core Parameters
        core_frame = Theme.create_frame(frame)
        core_frame.pack(fill="x", pady=(0, Sizes.PAD_M))

        Theme.create_label(
            core_frame, "Core Parameters",
            font=Fonts.LABEL_BOLD,
            text_color=Colors.PRIMARY_LIGHT
        ).pack(anchor="w", pady=(0, Sizes.PAD_S))

        # Get parameter definitions
        imm_def = VULNERABILITY_CORE_PARAM_DEFINITIONS['immunity_days']
        thresh_def = VULNERABILITY_CORE_PARAM_DEFINITIONS['swap_threshold']
        base_def = VULNERABILITY_CORE_PARAM_DEFINITIONS['base_score']

        # Immunity Days
        imm_frame = Theme.create_frame(core_frame)
        imm_frame.pack(fill="x", pady=Sizes.PAD_XS)
        Theme.create_label(imm_frame, "Immunity Days:", width=120).pack(side="left")
        self.immunity_var = ctk.StringVar(value=str(self.params.immunity_days))
        Theme.create_entry(imm_frame, width=80).configure(textvariable=self.immunity_var)
        Theme.create_entry(imm_frame, width=80).pack(side="left")
        Theme.create_hint(imm_frame, f"[{imm_def['min']}-{imm_def['max']}]").pack(side="left", padx=Sizes.PAD_S)

        # Recreate properly
        for w in imm_frame.winfo_children():
            w.destroy()
        Theme.create_label(imm_frame, "Immunity Days:", width=120).pack(side="left")
        imm_entry = Theme.create_entry(imm_frame, width=80)
        imm_entry.configure(textvariable=self.immunity_var)
        imm_entry.pack(side="left")
        Theme.create_hint(imm_frame, f"[{imm_def['min']}-{imm_def['max']}]").pack(side="left", padx=Sizes.PAD_S)

        # Base Score
        base_frame = Theme.create_frame(core_frame)
        base_frame.pack(fill="x", pady=Sizes.PAD_XS)
        Theme.create_label(base_frame, "Base Score:", width=120).pack(side="left")
        self.base_score_var = ctk.StringVar(value=str(self.params.base_score))
        base_entry = Theme.create_entry(base_frame, width=80)
        base_entry.configure(textvariable=self.base_score_var)
        base_entry.pack(side="left")
        Theme.create_hint(base_frame, f"[{int(base_def['min'])}-{int(base_def['max'])}]").pack(side="left", padx=Sizes.PAD_S)

        # Swap Threshold
        thresh_frame = Theme.create_frame(core_frame)
        thresh_frame.pack(fill="x", pady=Sizes.PAD_XS)
        Theme.create_label(thresh_frame, "Swap Threshold:", width=120).pack(side="left")
        self.threshold_var = ctk.StringVar(value=str(self.params.swap_threshold))
        thresh_entry = Theme.create_entry(thresh_frame, width=80)
        thresh_entry.configure(textvariable=self.threshold_var)
        thresh_entry.pack(side="left")
        Theme.create_hint(thresh_frame, f"[{int(thresh_def['min'])}-{int(thresh_def['max'])}]").pack(side="left", padx=Sizes.PAD_S)

        # Portfolio Settings
        ctk.CTkFrame(frame, fg_color=Colors.BORDER, height=1).pack(fill="x", pady=Sizes.PAD_M)

        port_frame = Theme.create_frame(frame)
        port_frame.pack(fill="x", pady=(0, Sizes.PAD_M))

        Theme.create_label(
            port_frame, "Portfolio Simulation",
            font=Fonts.LABEL_BOLD,
            text_color=Colors.PRIMARY_LIGHT
        ).pack(anchor="w", pady=(0, Sizes.PAD_S))

        pos_frame = Theme.create_frame(port_frame)
        pos_frame.pack(fill="x", pady=Sizes.PAD_XS)
        Theme.create_label(pos_frame, "Max Positions:", width=120).pack(side="left")
        self.max_positions_var = ctk.StringVar(value="3")
        pos_entry = Theme.create_entry(pos_frame, width=80)
        pos_entry.configure(textvariable=self.max_positions_var)
        pos_entry.pack(side="left")
        Theme.create_hint(pos_frame, "[1-20]").pack(side="left", padx=Sizes.PAD_S)

        # Feature Configuration
        ctk.CTkFrame(frame, fg_color=Colors.BORDER, height=1).pack(fill="x", pady=Sizes.PAD_M)

        Theme.create_label(
            frame, "Feature Configuration",
            font=Fonts.LABEL_BOLD,
            text_color=Colors.PRIMARY_LIGHT
        ).pack(anchor="w", pady=(0, Sizes.PAD_S))

        # Create widgets for each feature
        self.feature_vars = {}
        for feature_name, definition in ENHANCED_FEATURE_DEFINITIONS.items():
            self.feature_vars[feature_name] = {}
            self._create_feature_widget(frame, feature_name, definition)

        # Initialize feature values
        self._load_feature_values()

    def _create_feature_widget(self, parent: ctk.CTkFrame, feature_name: str, definition: dict):
        """Create a widget section for a single feature."""
        frame = Theme.create_card(parent)
        frame.pack(fill="x", pady=Sizes.PAD_XS)

        content = Theme.create_frame(frame)
        content.pack(fill="x", padx=Sizes.PAD_S, pady=Sizes.PAD_S)

        # Header row
        header_frame = Theme.create_frame(content)
        header_frame.pack(fill="x")

        enabled_var = ctk.BooleanVar(value=False)
        self.feature_vars[feature_name]['enabled'] = enabled_var

        Theme.create_checkbox(
            header_frame,
            definition['name'],
            variable=enabled_var
        ).pack(side="left")

        importance = definition.get('importance', 'MEDIUM')
        imp_color = Colors.SUCCESS if importance == 'HIGH' else (Colors.WARNING if importance == 'MEDIUM' else Colors.TEXT_MUTED)
        Theme.create_label(
            header_frame, f"[{importance}]",
            text_color=imp_color,
            font=Fonts.HINT
        ).pack(side="left", padx=Sizes.PAD_S)

        # Weight row
        weight_frame = Theme.create_frame(content)
        weight_frame.pack(fill="x", pady=(Sizes.PAD_XS, 0))

        Theme.create_label(weight_frame, "Weight:", width=60).pack(side="left")
        weight_var = ctk.StringVar(value=str(definition['recommended_weight']))
        self.feature_vars[feature_name]['weight'] = weight_var

        weight_entry = Theme.create_entry(weight_frame, width=60)
        weight_entry.configure(textvariable=weight_var)
        weight_entry.pack(side="left")

        weight_range = definition.get('weight_range', (-10.0, 10.0))
        Theme.create_hint(weight_frame, f"[{weight_range[0]} to {weight_range[1]}]").pack(side="left", padx=Sizes.PAD_S)

    def _load_feature_values(self):
        """Load feature values from current params."""
        for feature_name, weight in self.params.features.items():
            if feature_name in self.feature_vars:
                fv = self.feature_vars[feature_name]
                fv['enabled'].set(weight.enabled)
                fv['weight'].set(str(weight.weight))

    def _create_results_panel(self, parent: ctk.CTkFrame):
        """Create the results panel with tabs."""
        # Tabview for results
        self.tabview = Theme.create_tabview(parent)
        self.tabview.pack(fill="both", expand=True)

        # Summary Tab
        self.tabview.add("Summary")
        self._create_summary_tab(self.tabview.tab("Summary"))

        # Trade Analysis Tab
        self.tabview.add("Trade Analysis")
        self._create_trades_tab(self.tabview.tab("Trade Analysis"))

        # Portfolio Tab
        self.tabview.add("Portfolio")
        self._create_portfolio_tab(self.tabview.tab("Portfolio"))

        # Charts Tab
        self.tabview.add("Charts")
        self._create_charts_tab(self.tabview.tab("Charts"))

    def _create_summary_tab(self, parent: ctk.CTkFrame):
        """Create the summary tab."""
        self.summary_textbox = Theme.create_textbox(parent, height=600)
        self.summary_textbox.pack(fill="both", expand=True, padx=Sizes.PAD_S, pady=Sizes.PAD_S)
        self.summary_textbox.insert("1.0", "No analysis run yet. Load data and click 'Run Analysis'.")
        self.summary_textbox.configure(state="disabled")

    def _create_trades_tab(self, parent: ctk.CTkFrame):
        """Create the trade analysis tab."""
        # Header
        header_frame = Theme.create_frame(parent)
        header_frame.pack(fill="x", padx=Sizes.PAD_S, pady=Sizes.PAD_S)

        Theme.create_header(header_frame, "Trade Analysis", size="s").pack(side="left")
        Theme.create_button(
            header_frame, "Export CSV",
            command=self._export_trade_analysis,
            style="secondary", width=100, height=28
        ).pack(side="right")

        # Scrollable trade list
        self.trades_scroll = ctk.CTkScrollableFrame(parent, fg_color=Colors.SURFACE)
        self.trades_scroll.pack(fill="both", expand=True, padx=Sizes.PAD_S, pady=(0, Sizes.PAD_S))

        # Header row
        header = Theme.create_frame(self.trades_scroll)
        header.pack(fill="x", pady=(0, Sizes.PAD_S))

        for col, width in [("Trade ID", 80), ("Symbol", 80), ("Natural P/L", 100),
                           ("Vuln P/L", 100), ("Difference", 100), ("Category", 120)]:
            Theme.create_label(header, col, font=Fonts.LABEL_BOLD, width=width).pack(side="left", padx=2)

        ctk.CTkFrame(self.trades_scroll, fg_color=Colors.BORDER, height=1).pack(fill="x")

        self.trades_content = Theme.create_frame(self.trades_scroll)
        self.trades_content.pack(fill="both", expand=True)

    def _create_portfolio_tab(self, parent: ctk.CTkFrame):
        """Create the portfolio analysis tab."""
        parent.grid_columnconfigure(0, weight=1)
        parent.grid_columnconfigure(1, weight=1)
        parent.grid_rowconfigure(0, weight=1)
        parent.grid_rowconfigure(1, weight=0)

        # FIFO results
        fifo_card = Theme.create_card(parent)
        fifo_card.grid(row=0, column=0, sticky="nsew", padx=(Sizes.PAD_S, Sizes.PAD_XS), pady=Sizes.PAD_S)

        fifo_header = Theme.create_frame(fifo_card)
        fifo_header.pack(fill="x", padx=Sizes.PAD_M, pady=Sizes.PAD_S)
        Theme.create_header(fifo_header, "Natural Portfolio (FIFO)", size="s").pack(anchor="w")

        self.portfolio_fifo_text = Theme.create_textbox(fifo_card, height=300)
        self.portfolio_fifo_text.pack(fill="both", expand=True, padx=Sizes.PAD_M, pady=(0, Sizes.PAD_M))
        self.portfolio_fifo_text.insert("1.0", "Run portfolio analysis to see FIFO results...")
        self.portfolio_fifo_text.configure(state="disabled")

        # Vulnerability results
        vuln_card = Theme.create_card(parent)
        vuln_card.grid(row=0, column=1, sticky="nsew", padx=(Sizes.PAD_XS, Sizes.PAD_S), pady=Sizes.PAD_S)

        vuln_header = Theme.create_frame(vuln_card)
        vuln_header.pack(fill="x", padx=Sizes.PAD_M, pady=Sizes.PAD_S)
        Theme.create_header(vuln_header, "Vulnerability-Optimized", size="s").pack(anchor="w")

        self.portfolio_vuln_text = Theme.create_textbox(vuln_card, height=300)
        self.portfolio_vuln_text.pack(fill="both", expand=True, padx=Sizes.PAD_M, pady=(0, Sizes.PAD_M))
        self.portfolio_vuln_text.insert("1.0", "Run portfolio analysis to see vulnerability-optimized results...")
        self.portfolio_vuln_text.configure(state="disabled")

        # Comparison
        comparison_card = Theme.create_card(parent)
        comparison_card.grid(row=1, column=0, columnspan=2, sticky="ew", padx=Sizes.PAD_S, pady=(0, Sizes.PAD_S))

        comp_header = Theme.create_frame(comparison_card)
        comp_header.pack(fill="x", padx=Sizes.PAD_M, pady=Sizes.PAD_S)
        Theme.create_header(comp_header, "Comparison", size="s").pack(anchor="w")

        self.portfolio_comparison_text = Theme.create_textbox(comparison_card, height=120)
        self.portfolio_comparison_text.pack(fill="x", padx=Sizes.PAD_M, pady=(0, Sizes.PAD_M))
        self.portfolio_comparison_text.insert("1.0", "Run portfolio analysis to see comparison...")
        self.portfolio_comparison_text.configure(state="disabled")

    def _create_charts_tab(self, parent: ctk.CTkFrame):
        """Create the charts tab with Plotly integration."""
        Theme.create_label(
            parent,
            "Charts will be displayed here after running analysis.\n\n"
            "Plotly charts will open in browser for interactive viewing.",
            text_color=Colors.TEXT_SECONDARY
        ).pack(expand=True)

        # Button to show charts
        self.show_charts_btn = Theme.create_button(
            parent, "Show Interactive Charts",
            command=self._show_charts,
            style="secondary"
        )
        self.show_charts_btn.pack(pady=Sizes.PAD_L)
        self.show_charts_btn.configure(state="disabled")

    def _load_presets(self):
        """Load available presets into combo box."""
        presets = self.preset_manager.get_preset_names()
        self.preset_combo.configure(values=presets)

    def _on_preset_selected(self, preset_name: str):
        """Handle preset selection."""
        preset = self.preset_manager.load_preset(preset_name)
        if preset:
            self.params = preset
            self.immunity_var.set(str(self.params.immunity_days))
            self.threshold_var.set(str(self.params.swap_threshold))
            self.base_score_var.set(str(self.params.base_score))
            self._load_feature_values()

    def _get_current_params(self) -> VulnerabilityScoreParams:
        """Get current parameters from UI."""
        features = {}

        for feature_name, vars_dict in self.feature_vars.items():
            features[feature_name] = FeatureWeight(
                enabled=vars_dict['enabled'].get(),
                weight=float(vars_dict['weight'].get())
            )

        return VulnerabilityScoreParams(
            name="Custom",
            description="User-defined parameters",
            immunity_days=int(self.immunity_var.get()),
            base_score=float(self.base_score_var.get()),
            swap_threshold=float(self.threshold_var.get()),
            features=features
        )

    def _load_trade_log(self):
        """Load a trade log file."""
        from tkinter import filedialog

        filepath = filedialog.askopenfilename(
            title="Select Trade Log",
            filetypes=[("CSV files", "*.csv"), ("All files", "*.*")],
            initialdir=str(Path('logs'))
        )

        if not filepath:
            return

        try:
            self.data_loader = BacktestTradeLoader(self.data_directory)
            self.trades, self.price_data, report = self.data_loader.load_from_trade_log(
                Path(filepath)
            )

            if not report.is_valid:
                show_error(self.root, "Data Warning", report.get_summary())

            self.data_status_var.set(f"Loaded {len(self.trades)} trades")
            show_info(self.root, "Success", f"Loaded {len(self.trades)} trades from {len(self.price_data)} symbols")

        except Exception as e:
            show_error(self.root, "Error", f"Failed to load trade log:\n{str(e)}")
            traceback.print_exc()

    def _load_multiple_trade_logs(self):
        """Load multiple trade log files."""
        from tkinter import filedialog

        filepaths = filedialog.askopenfilenames(
            title="Select Trade Logs",
            filetypes=[("CSV files", "*.csv"), ("All files", "*.*")],
            initialdir=str(Path('logs'))
        )

        if not filepaths:
            return

        try:
            self.data_loader = BacktestTradeLoader(self.data_directory)
            all_trades = []
            all_price_data = {}

            for filepath in filepaths:
                trades, price_data, report = self.data_loader.load_from_trade_log(Path(filepath))
                all_trades.extend(trades)
                all_price_data.update(price_data)

            self.trades = all_trades
            self.price_data = all_price_data

            self.data_status_var.set(f"Loaded {len(self.trades)} trades from {len(filepaths)} files")
            show_info(self.root, "Success", f"Loaded {len(self.trades)} trades from {len(filepaths)} files")

        except Exception as e:
            show_error(self.root, "Error", f"Failed to load trade logs:\n{str(e)}")

    def _set_data_directory(self):
        """Set the data directory."""
        from tkinter import filedialog

        directory = filedialog.askdirectory(
            title="Select Data Directory",
            initialdir=str(self.data_directory)
        )
        if directory:
            self.data_directory = Path(directory)
            self.data_status_var.set(f"Data dir: {self.data_directory}")

    def _run_analysis(self):
        """Run the vulnerability analysis."""
        if not self.trades:
            show_error(self.root, "No Data", "Please load a trade log first.")
            return

        params = self._get_current_params()

        # Create progress dialog
        progress_dialog = CTkProgressDialog(
            self.root,
            "Running Analysis",
            "Analyzing trades..."
        )

        def run_analysis_thread():
            try:
                progress_dialog.update(10, "Initializing analyzer...")
                analyzer = VulnerabilityAnalyzer(params)

                progress_dialog.update(30, f"Processing {len(self.trades)} trades...")
                self.current_report = analyzer.analyze_backtest(self.trades, self.price_data)

                progress_dialog.update(70, "Updating results...")
                self.root.after(0, self._update_results)

                progress_dialog.update(90, "Running portfolio simulation...")
                self.root.after(0, lambda: self._run_portfolio_simulation(params))

                progress_dialog.update(100, "Complete!")
                self.root.after(500, progress_dialog.close)

                self.root.after(600, lambda: show_info(
                    self.root, "Analysis Complete",
                    f"Trades affected: {self.current_report.trades_affected_by_vulnerability}\n"
                    f"P/L difference: ${self.current_report.total_pl_difference:,.2f}"
                ))

            except Exception as e:
                self.root.after(0, progress_dialog.close)
                self.root.after(100, lambda: show_error(self.root, "Error", f"Analysis failed:\n{str(e)}"))
                traceback.print_exc()

        thread = threading.Thread(target=run_analysis_thread, daemon=True)
        thread.start()

    def _update_results(self):
        """Update all result displays."""
        self._update_summary()
        self._update_trades_table()
        self.show_charts_btn.configure(state="normal")
        self.tabview.set("Summary")

    def _update_summary(self):
        """Update the summary tab."""
        if not self.current_report:
            return

        self.summary_textbox.configure(state="normal")
        self.summary_textbox.delete("1.0", "end")

        self.summary_textbox.insert("1.0", self.current_report.get_summary_text())
        self.summary_textbox.insert("end", "\n\n" + "=" * 50 + "\n")
        self.summary_textbox.insert("end", "KEY INSIGHT\n")
        self.summary_textbox.insert("end", "=" * 50 + "\n")
        self.summary_textbox.insert("end", self.current_report.get_key_insight())
        self.summary_textbox.insert("end", "\n\n" + "=" * 50 + "\n")
        self.summary_textbox.insert("end", "RECOMMENDATION\n")
        self.summary_textbox.insert("end", "=" * 50 + "\n")
        self.summary_textbox.insert("end", self.current_report.get_recommendation())

        self.summary_textbox.configure(state="disabled")

    def _update_trades_table(self):
        """Update the trades table."""
        # Clear existing
        for widget in self.trades_content.winfo_children():
            widget.destroy()

        if not self.current_report:
            return

        for trade in self.current_report.trades[:100]:  # Limit to 100 for performance
            row = Theme.create_frame(self.trades_content)
            row.pack(fill="x", pady=1)

            Theme.create_label(row, str(trade.trade_id), width=80).pack(side="left", padx=2)
            Theme.create_label(row, trade.symbol, width=80).pack(side="left", padx=2)
            Theme.create_label(row, f"${trade.pl_natural_dollars:,.2f}", width=100).pack(side="left", padx=2)
            Theme.create_label(row, f"${trade.pl_if_exited_at_vulnerability_dollars:,.2f}", width=100).pack(side="left", padx=2)

            diff = trade.pl_difference_dollars
            diff_color = Colors.SUCCESS if diff > 0 else (Colors.ERROR if diff < 0 else Colors.TEXT_PRIMARY)
            Theme.create_label(row, f"${diff:+,.2f}", width=100, text_color=diff_color).pack(side="left", padx=2)

            cat_color = Colors.SUCCESS if "BENEFICIAL" in trade.benefit_category else (
                Colors.ERROR if "HURT" in trade.benefit_category else Colors.TEXT_MUTED
            )
            Theme.create_label(row, trade.benefit_category, width=120, text_color=cat_color).pack(side="left", padx=2)

    def _run_portfolio_simulation(self, params: VulnerabilityScoreParams):
        """Run portfolio simulation."""
        try:
            from Classes.VulnerabilityScorer.portfolio_simulator import PortfolioSimulator

            max_positions = int(self.max_positions_var.get())
            simulator = PortfolioSimulator(
                params=params,
                max_positions=max_positions,
                initial_capital=100000.0
            )

            self.portfolio_fifo_result = simulator.simulate_fifo(self.trades, self.price_data)
            self.portfolio_vuln_result = simulator.simulate_vulnerability(self.trades, self.price_data)

            self._update_portfolio_display()

        except Exception as e:
            # Portfolio simulation is optional, just log the error
            print(f"Portfolio simulation error: {e}")

    def _update_portfolio_display(self):
        """Update portfolio display."""
        if not self.portfolio_fifo_result or not self.portfolio_vuln_result:
            return

        # FIFO results
        self.portfolio_fifo_text.configure(state="normal")
        self.portfolio_fifo_text.delete("1.0", "end")
        self.portfolio_fifo_text.insert("1.0", f"Total P/L: ${self.portfolio_fifo_result.total_pl:,.2f}\n")
        self.portfolio_fifo_text.insert("end", f"Total Trades: {self.portfolio_fifo_result.total_trades}\n")
        self.portfolio_fifo_text.insert("end", f"Win Rate: {self.portfolio_fifo_result.win_rate:.1f}%\n")
        self.portfolio_fifo_text.configure(state="disabled")

        # Vulnerability results
        self.portfolio_vuln_text.configure(state="normal")
        self.portfolio_vuln_text.delete("1.0", "end")
        self.portfolio_vuln_text.insert("1.0", f"Total P/L: ${self.portfolio_vuln_result.total_pl:,.2f}\n")
        self.portfolio_vuln_text.insert("end", f"Total Trades: {self.portfolio_vuln_result.total_trades}\n")
        self.portfolio_vuln_text.insert("end", f"Win Rate: {self.portfolio_vuln_result.win_rate:.1f}%\n")
        self.portfolio_vuln_text.insert("end", f"Swaps: {self.portfolio_vuln_result.swap_count}\n")
        self.portfolio_vuln_text.configure(state="disabled")

        # Comparison
        improvement = self.portfolio_vuln_result.total_pl - self.portfolio_fifo_result.total_pl
        improvement_pct = (improvement / abs(self.portfolio_fifo_result.total_pl) * 100) if self.portfolio_fifo_result.total_pl != 0 else 0

        self.portfolio_comparison_text.configure(state="normal")
        self.portfolio_comparison_text.delete("1.0", "end")
        self.portfolio_comparison_text.insert("1.0", f"P/L Improvement: ${improvement:,.2f} ({improvement_pct:+.1f}%)\n")
        if improvement > 0:
            self.portfolio_comparison_text.insert("end", "Vulnerability scoring IMPROVED portfolio performance")
        else:
            self.portfolio_comparison_text.insert("end", "Vulnerability scoring did not improve performance with current parameters")
        self.portfolio_comparison_text.configure(state="disabled")

    def _show_charts(self):
        """Show interactive charts using Plotly."""
        if not self.current_report:
            show_error(self.root, "No Data", "Please run analysis first.")
            return

        try:
            import plotly.graph_objects as go
            from plotly.subplots import make_subplots

            # Create subplot figure
            fig = make_subplots(
                rows=2, cols=2,
                subplot_titles=(
                    "Trade Categorization",
                    "Cumulative P/L Impact",
                    "P/L Comparison",
                    "Vulnerability Timeline"
                )
            )

            # Trade categorization pie chart
            not_affected = self.current_report.total_trades - self.current_report.trades_affected_by_vulnerability
            labels = ['Benefited', 'Hurt', 'Neutral', 'Not Affected']
            values = [
                self.current_report.benefited_count,
                self.current_report.hurt_count,
                self.current_report.neutral_count,
                not_affected
            ]
            colors = [Colors.SUCCESS, Colors.ERROR, Colors.TEXT_MUTED, Colors.PRIMARY]

            fig.add_trace(
                go.Pie(labels=labels, values=values, marker_colors=colors),
                row=1, col=1
            )

            # P/L comparison bar chart
            trades = self.current_report.trades[:20]  # Limit for readability
            symbols = [t.symbol for t in trades]
            natural_pls = [t.pl_natural_dollars for t in trades]
            vuln_pls = [t.pl_if_exited_at_vulnerability_dollars for t in trades]

            fig.add_trace(
                go.Bar(name='Natural P/L', x=symbols, y=natural_pls, marker_color=Colors.PRIMARY),
                row=2, col=1
            )
            fig.add_trace(
                go.Bar(name='Vulnerability P/L', x=symbols, y=vuln_pls, marker_color=Colors.SUCCESS),
                row=2, col=1
            )

            # Update layout
            fig.update_layout(
                template='plotly_dark',
                paper_bgcolor=Colors.BG_DARK,
                plot_bgcolor=Colors.SURFACE,
                title_text="Vulnerability Score Analysis",
                showlegend=True,
                height=800
            )

            fig.show()

        except ImportError:
            show_error(self.root, "Plotly Required", "Please install plotly: pip install plotly")
        except Exception as e:
            show_error(self.root, "Error", f"Failed to show charts:\n{str(e)}")

    # Placeholder methods for menu actions
    def _export_report(self): show_info(self.root, "Export", "Export report functionality")
    def _export_params(self): show_info(self.root, "Export", "Export parameters functionality")
    def _import_params(self): show_info(self.root, "Import", "Import parameters functionality")
    def _save_current_preset(self): show_info(self.root, "Save", "Save preset functionality")
    def _manage_presets(self): show_info(self.root, "Manage", "Manage presets functionality")
    def _find_optimal(self): show_info(self.root, "Optimize", "Find optimal parameters functionality")
    def _compare_presets(self): show_info(self.root, "Compare", "Compare presets functionality")
    def _run_sensitivity_analysis(self): show_info(self.root, "Analysis", "Sensitivity analysis functionality")
    def _run_walk_forward(self): show_info(self.root, "Validation", "Walk-forward validation functionality")
    def _export_trade_analysis(self): show_info(self.root, "Export", "Export trade analysis functionality")


class CTkDropdownMenu:
    """Simple dropdown menu for CTk."""

    def __init__(self, parent, anchor_widget, items):
        self.parent = parent
        self.anchor = anchor_widget
        self.items = items
        self.menu = None

    def show(self):
        if self.menu:
            self.menu.destroy()

        self.menu = ctk.CTkToplevel(self.parent)
        self.menu.overrideredirect(True)
        self.menu.configure(fg_color=Colors.SURFACE)

        # Position below anchor
        x = self.anchor.winfo_rootx()
        y = self.anchor.winfo_rooty() + self.anchor.winfo_height()
        self.menu.geometry(f"+{x}+{y}")

        for item in self.items:
            if item is None:
                ctk.CTkFrame(self.menu, fg_color=Colors.BORDER, height=1).pack(fill="x", padx=5, pady=2)
            else:
                label, command = item
                btn = ctk.CTkButton(
                    self.menu,
                    text=label,
                    command=lambda c=command: self._on_click(c),
                    fg_color="transparent",
                    hover_color=Colors.SURFACE_HOVER,
                    anchor="w",
                    height=28,
                    corner_radius=0
                )
                btn.pack(fill="x", padx=2, pady=1)

        # Bind click outside to close menu
        self.menu.bind("<Button-1>", self._on_menu_click)
        self.parent.bind("<Button-1>", lambda e: self._close_menu(), add="+")

        # Bind Escape key to close
        self.menu.bind("<Escape>", lambda e: self._close_menu())

        # Grab focus with slight delay to prevent immediate close
        self.menu.after(50, self._setup_focus_handling)

    def _setup_focus_handling(self):
        """Setup focus handling after menu is visible."""
        if self.menu and self.menu.winfo_exists():
            self.menu.focus_set()
            self.menu.grab_set()

    def _on_menu_click(self, event):
        """Handle click inside menu - don't close."""
        pass

    def _close_menu(self):
        """Close the menu."""
        if self.menu and self.menu.winfo_exists():
            self.menu.grab_release()
            self.menu.destroy()
            self.menu = None

    def _on_click(self, command):
        self._close_menu()
        command()


class CTkProgressDialog:
    """Progress dialog for long-running operations."""

    def __init__(self, parent, title: str, message: str):
        self.parent = parent
        self.dialog = ctk.CTkToplevel(parent)
        self.dialog.title(title)
        self.dialog.geometry("400x120")
        self.dialog.transient(parent)
        self.dialog.configure(fg_color=Colors.BG_DARK)

        # Center on parent
        self.dialog.update_idletasks()
        x = parent.winfo_x() + (parent.winfo_width() - 400) // 2
        y = parent.winfo_y() + (parent.winfo_height() - 120) // 2
        self.dialog.geometry(f"+{x}+{y}")

        self.message_var = ctk.StringVar(value=message)
        Theme.create_label(self.dialog, "", textvariable=self.message_var).pack(pady=(Sizes.PAD_L, Sizes.PAD_S))

        self.progress = Theme.create_progressbar(self.dialog)
        self.progress.pack(fill="x", padx=Sizes.PAD_L, pady=Sizes.PAD_S)
        self.progress.set(0)

        self.dialog.grab_set()
        self.dialog.update()

    def update(self, progress: float, message: str = None):
        self.progress.set(progress / 100)
        if message:
            self.message_var.set(message)
        self.dialog.update()

    def close(self):
        self.dialog.grab_release()
        self.dialog.destroy()


def main():
    """Main entry point for GUI."""
    app = CTkVulnerabilityModelerGUI()
    app.run()


if __name__ == "__main__":
    main()
