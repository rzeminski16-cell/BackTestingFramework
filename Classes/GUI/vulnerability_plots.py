"""
Visualization Charts for Vulnerability Score Modeler.

This module provides matplotlib-based visualizations for the vulnerability
score analysis, including:
- Vulnerability score timeline charts
- P/L impact comparison charts
- Trade categorization pie charts
- Feature contribution heatmaps
"""

import matplotlib
matplotlib.use('TkAgg')  # Use TkAgg backend for Tkinter integration

import matplotlib.pyplot as plt
from matplotlib.figure import Figure
from matplotlib.backends.backend_tkagg import FigureCanvasTkAgg, NavigationToolbar2Tk
import matplotlib.dates as mdates
from matplotlib.patches import Patch
import numpy as np
import pandas as pd
from datetime import datetime
from typing import Dict, List, Optional, Any, Tuple
import tkinter as tk
from tkinter import ttk


# Color scheme
COLORS = {
    'score_line': '#2E5994',
    'threshold_line': '#E74C3C',
    'immunity_region': '#C8E6C9',
    'vulnerable_region': '#FFCDD2',
    'pl_positive': '#27AE60',
    'pl_negative': '#E74C3C',
    'benefited': '#27AE60',
    'hurt': '#E74C3C',
    'neutral': '#95A5A6',
    'background': '#F5F5F5',
    'grid': '#E0E0E0'
}


class VulnerabilityChartFrame(ttk.Frame):
    """
    A Tkinter frame containing a matplotlib chart.

    This is a reusable component that can be embedded in any Tkinter window.
    """

    def __init__(self, parent, figsize: Tuple[float, float] = (8, 5)):
        """
        Initialize the chart frame.

        Args:
            parent: Parent Tkinter widget
            figsize: Figure size as (width, height) in inches
        """
        super().__init__(parent)

        self.figure = Figure(figsize=figsize, dpi=100)
        self.figure.patch.set_facecolor(COLORS['background'])

        self.canvas = FigureCanvasTkAgg(self.figure, master=self)
        self.canvas_widget = self.canvas.get_tk_widget()
        self.canvas_widget.pack(side=tk.TOP, fill=tk.BOTH, expand=True)

        # Add navigation toolbar
        self.toolbar = NavigationToolbar2Tk(self.canvas, self)
        self.toolbar.update()
        self.toolbar.pack(side=tk.BOTTOM, fill=tk.X)

    def clear(self):
        """Clear the figure."""
        self.figure.clear()

    def refresh(self):
        """Refresh the canvas."""
        self.canvas.draw()


def plot_vulnerability_timeline(
    chart_frame: VulnerabilityChartFrame,
    timeline: List[Dict[str, Any]],
    swap_threshold: float,
    immunity_days: int,
    title: str = "Vulnerability Score Timeline"
) -> None:
    """
    Plot the vulnerability score over time for a single trade.

    Args:
        chart_frame: VulnerabilityChartFrame to plot on
        timeline: List of daily vulnerability records
        swap_threshold: Score threshold for swapping
        immunity_days: Number of immunity days
        title: Chart title
    """
    chart_frame.clear()
    ax = chart_frame.figure.add_subplot(111)

    if not timeline:
        ax.text(0.5, 0.5, "No data to display", ha='center', va='center', fontsize=12)
        chart_frame.refresh()
        return

    # Extract data
    dates = [r['date'] if isinstance(r['date'], datetime) else pd.to_datetime(r['date']) for r in timeline]
    scores = [r['vulnerability_score'] for r in timeline]
    is_immune = [r['is_immune'] for r in timeline]

    # Plot immunity region
    immunity_mask = np.array(is_immune)
    if immunity_mask.any():
        ax.fill_between(
            dates, 0, 100,
            where=immunity_mask,
            color=COLORS['immunity_region'],
            alpha=0.5,
            label='Immunity Period'
        )

    # Plot vulnerable region
    vulnerable_mask = np.array(scores) < swap_threshold
    if vulnerable_mask.any():
        ax.fill_between(
            dates, 0, swap_threshold,
            where=~immunity_mask & vulnerable_mask,
            color=COLORS['vulnerable_region'],
            alpha=0.3,
            label='Vulnerable Zone'
        )

    # Plot score line
    ax.plot(dates, scores, color=COLORS['score_line'], linewidth=2, label='Vulnerability Score')

    # Plot threshold line
    ax.axhline(y=swap_threshold, color=COLORS['threshold_line'], linestyle='--', linewidth=1.5, label=f'Swap Threshold ({swap_threshold})')

    # Format
    ax.set_xlabel('Date')
    ax.set_ylabel('Vulnerability Score')
    ax.set_title(title)
    ax.set_ylim(0, 105)
    ax.legend(loc='upper right')
    ax.grid(True, color=COLORS['grid'], alpha=0.5)

    # Format x-axis dates
    ax.xaxis.set_major_formatter(mdates.DateFormatter('%Y-%m-%d'))
    ax.xaxis.set_major_locator(mdates.AutoDateLocator())
    chart_frame.figure.autofmt_xdate()

    chart_frame.figure.tight_layout()
    chart_frame.refresh()


def plot_pl_comparison(
    chart_frame: VulnerabilityChartFrame,
    trades: List[Dict[str, Any]],
    title: str = "P/L Comparison: Natural vs Vulnerability-Based Exit"
) -> None:
    """
    Plot P/L comparison between natural exit and vulnerability-based exit.

    For >100 trades, uses a scatter plot with summary statistics instead of bar chart.

    Args:
        chart_frame: VulnerabilityChartFrame to plot on
        trades: List of trade analysis dicts
        title: Chart title
    """
    chart_frame.clear()

    if not trades:
        ax = chart_frame.figure.add_subplot(111)
        ax.text(0.5, 0.5, "No data to display", ha='center', va='center', fontsize=12)
        chart_frame.refresh()
        return

    # Extract data
    affected_trades = [t for t in trades if t.get('would_have_been_swapped', False)]

    if not affected_trades:
        ax = chart_frame.figure.add_subplot(111)
        ax.text(0.5, 0.5, "No trades would be affected by vulnerability scoring",
                ha='center', va='center', fontsize=12)
        chart_frame.refresh()
        return

    # For large trade counts (>100), use scatter plot with summary
    if len(affected_trades) > 100:
        _plot_pl_comparison_large(chart_frame, affected_trades, title)
        return

    # For moderate trade counts (25-100), use condensed bar chart
    if len(affected_trades) > 25:
        _plot_pl_comparison_medium(chart_frame, affected_trades, title)
        return

    # Standard bar chart for small trade counts
    ax = chart_frame.figure.add_subplot(111)

    trade_ids = [t['trade_id'] for t in affected_trades]
    natural_pl = [t['pl_natural_dollars'] for t in affected_trades]
    vuln_pl = [t['pl_if_exited_at_vulnerability_dollars'] for t in affected_trades]

    x = np.arange(len(trade_ids))
    width = 0.35

    # Create bars
    bars1 = ax.bar(x - width/2, natural_pl, width, label='Natural Exit',
                   color=[COLORS['pl_positive'] if p >= 0 else COLORS['pl_negative'] for p in natural_pl])
    bars2 = ax.bar(x + width/2, vuln_pl, width, label='Vulnerability Exit',
                   color=[COLORS['pl_positive'] if p >= 0 else COLORS['pl_negative'] for p in vuln_pl],
                   alpha=0.7, edgecolor='black', linewidth=1)

    # Format
    ax.set_xlabel('Trade')
    ax.set_ylabel('P/L ($)')
    ax.set_title(title)
    ax.set_xticks(x)
    ax.set_xticklabels(trade_ids, rotation=45, ha='right')
    ax.legend()
    ax.axhline(y=0, color='black', linewidth=0.5)
    ax.grid(True, axis='y', color=COLORS['grid'], alpha=0.5)

    chart_frame.figure.tight_layout()
    chart_frame.refresh()


def _plot_pl_comparison_medium(
    chart_frame: VulnerabilityChartFrame,
    affected_trades: List[Dict[str, Any]],
    title: str
) -> None:
    """
    Plot P/L comparison for 25-100 trades using a condensed bar chart.

    Shows P/L difference instead of side-by-side bars for cleaner display.
    """
    ax = chart_frame.figure.add_subplot(111)

    # Calculate P/L differences
    trade_ids = [t['trade_id'] for t in affected_trades]
    pl_diffs = [
        t['pl_if_exited_at_vulnerability_dollars'] - t['pl_natural_dollars']
        for t in affected_trades
    ]

    # Sort by P/L difference for better visualization
    sorted_data = sorted(zip(trade_ids, pl_diffs), key=lambda x: x[1])
    trade_ids = [x[0] for x in sorted_data]
    pl_diffs = [x[1] for x in sorted_data]

    x = np.arange(len(trade_ids))
    colors = [COLORS['benefited'] if d >= 0 else COLORS['hurt'] for d in pl_diffs]

    # Create single bar chart
    ax.bar(x, pl_diffs, color=colors, alpha=0.8)

    # Format - no x labels for cleaner display
    ax.set_xlabel(f'Trades (sorted by P/L difference, n={len(affected_trades)})')
    ax.set_ylabel('P/L Difference ($)')
    ax.set_title(f'{title}\n(Vulnerability - Natural)')
    ax.set_xticks([])  # Hide x ticks for cleaner display
    ax.axhline(y=0, color='black', linewidth=1)
    ax.grid(True, axis='y', color=COLORS['grid'], alpha=0.5)

    # Add summary statistics
    total_diff = sum(pl_diffs)
    positive = sum(1 for d in pl_diffs if d > 0)
    negative = sum(1 for d in pl_diffs if d < 0)
    summary = f'Total: ${total_diff:,.0f} | Benefited: {positive} | Hurt: {negative}'
    ax.text(0.5, -0.12, summary, transform=ax.transAxes, ha='center', fontsize=9)

    chart_frame.figure.tight_layout()
    chart_frame.refresh()


def _plot_pl_comparison_large(
    chart_frame: VulnerabilityChartFrame,
    affected_trades: List[Dict[str, Any]],
    title: str
) -> None:
    """
    Plot P/L comparison for >100 trades using scatter plot and histogram.

    Creates a 2-panel view:
    - Left: Scatter plot of Natural P/L vs Vulnerability P/L
    - Right: Histogram of P/L differences
    """
    # Create 2 subplots
    ax1 = chart_frame.figure.add_subplot(121)
    ax2 = chart_frame.figure.add_subplot(122)

    natural_pl = [t['pl_natural_dollars'] for t in affected_trades]
    vuln_pl = [t['pl_if_exited_at_vulnerability_dollars'] for t in affected_trades]
    pl_diffs = [v - n for v, n in zip(vuln_pl, natural_pl)]

    # Color by whether vulnerability was better
    colors = [COLORS['benefited'] if d >= 0 else COLORS['hurt'] for d in pl_diffs]

    # Left panel: Scatter plot
    ax1.scatter(natural_pl, vuln_pl, c=colors, alpha=0.5, s=20, edgecolors='none')

    # Add reference line (y=x)
    all_pl = natural_pl + vuln_pl
    min_pl, max_pl = min(all_pl), max(all_pl)
    ax1.plot([min_pl, max_pl], [min_pl, max_pl], 'k--', linewidth=1, alpha=0.5, label='Equal P/L')

    ax1.set_xlabel('Natural P/L ($)')
    ax1.set_ylabel('Vulnerability P/L ($)')
    ax1.set_title(f'P/L Scatter (n={len(affected_trades)})')
    ax1.legend(loc='upper left', fontsize=8)
    ax1.grid(True, color=COLORS['grid'], alpha=0.5)

    # Add text explaining interpretation
    ax1.text(0.05, 0.95, 'Above line = Vuln better',
             transform=ax1.transAxes, fontsize=8, va='top', color=COLORS['benefited'])
    ax1.text(0.05, 0.88, 'Below line = Natural better',
             transform=ax1.transAxes, fontsize=8, va='top', color=COLORS['hurt'])

    # Right panel: Histogram of differences
    bins = min(50, len(pl_diffs) // 4)
    n, bins_edges, patches = ax2.hist(pl_diffs, bins=bins, color=COLORS['score_line'],
                                       alpha=0.7, edgecolor='white')

    # Color bars based on positive/negative
    for i, (patch, left_edge) in enumerate(zip(patches, bins_edges[:-1])):
        right_edge = bins_edges[i + 1]
        center = (left_edge + right_edge) / 2
        if center >= 0:
            patch.set_facecolor(COLORS['benefited'])
        else:
            patch.set_facecolor(COLORS['hurt'])

    # Add vertical line at 0
    ax2.axvline(x=0, color='black', linewidth=1.5)

    # Add statistics
    mean_diff = np.mean(pl_diffs)
    median_diff = np.median(pl_diffs)
    ax2.axvline(x=mean_diff, color='blue', linewidth=1, linestyle='--', label=f'Mean: ${mean_diff:,.0f}')
    ax2.axvline(x=median_diff, color='orange', linewidth=1, linestyle=':', label=f'Median: ${median_diff:,.0f}')

    ax2.set_xlabel('P/L Difference ($)')
    ax2.set_ylabel('Number of Trades')
    ax2.set_title('Distribution of P/L Differences')
    ax2.legend(loc='upper right', fontsize=8)
    ax2.grid(True, axis='y', color=COLORS['grid'], alpha=0.5)

    # Add summary stats below
    total_diff = sum(pl_diffs)
    positive = sum(1 for d in pl_diffs if d > 0)
    negative = sum(1 for d in pl_diffs if d < 0)
    summary = f'Total Impact: ${total_diff:,.0f} | Benefited: {positive} ({positive/len(pl_diffs)*100:.0f}%) | Hurt: {negative} ({negative/len(pl_diffs)*100:.0f}%)'

    chart_frame.figure.suptitle(title, fontsize=11, y=0.98)
    chart_frame.figure.text(0.5, 0.02, summary, ha='center', fontsize=9)

    chart_frame.figure.tight_layout(rect=[0, 0.05, 1, 0.95])
    chart_frame.refresh()


def plot_trade_categorization(
    chart_frame: VulnerabilityChartFrame,
    benefited: int,
    hurt: int,
    neutral: int,
    not_affected: int,
    title: str = "Trade Impact Categorization"
) -> None:
    """
    Plot pie chart of trade categorization.

    Args:
        chart_frame: VulnerabilityChartFrame to plot on
        benefited: Count of trades that benefited
        hurt: Count of trades that were hurt
        neutral: Count of neutral trades
        not_affected: Count of trades not affected
        title: Chart title
    """
    chart_frame.clear()
    ax = chart_frame.figure.add_subplot(111)

    # Prepare data
    sizes = []
    labels = []
    colors = []
    explode = []

    if benefited > 0:
        sizes.append(benefited)
        labels.append(f'Benefited ({benefited})')
        colors.append(COLORS['benefited'])
        explode.append(0.05)

    if hurt > 0:
        sizes.append(hurt)
        labels.append(f'Hurt ({hurt})')
        colors.append(COLORS['hurt'])
        explode.append(0.05)

    if neutral > 0:
        sizes.append(neutral)
        labels.append(f'Neutral ({neutral})')
        colors.append(COLORS['neutral'])
        explode.append(0)

    if not_affected > 0:
        sizes.append(not_affected)
        labels.append(f'Not Affected ({not_affected})')
        colors.append('#BDC3C7')
        explode.append(0)

    if not sizes:
        ax.text(0.5, 0.5, "No data to display", ha='center', va='center', fontsize=12)
        chart_frame.refresh()
        return

    # Create pie chart
    wedges, texts, autotexts = ax.pie(
        sizes, explode=explode, labels=labels, colors=colors,
        autopct='%1.1f%%', startangle=90, pctdistance=0.75
    )

    # Style
    for autotext in autotexts:
        autotext.set_fontsize(10)
        autotext.set_fontweight('bold')

    ax.set_title(title)
    ax.axis('equal')

    chart_frame.figure.tight_layout()
    chart_frame.refresh()


def plot_feature_contributions(
    chart_frame: VulnerabilityChartFrame,
    feature_contributions: Dict[str, float],
    title: str = "Feature Contributions to Vulnerability Score"
) -> None:
    """
    Plot horizontal bar chart of feature contributions.

    Args:
        chart_frame: VulnerabilityChartFrame to plot on
        feature_contributions: Dict mapping feature name to contribution
        title: Chart title
    """
    chart_frame.clear()
    ax = chart_frame.figure.add_subplot(111)

    if not feature_contributions:
        ax.text(0.5, 0.5, "No feature contributions to display",
                ha='center', va='center', fontsize=12)
        chart_frame.refresh()
        return

    # Prepare data
    features = list(feature_contributions.keys())
    contributions = list(feature_contributions.values())

    # Sort by absolute contribution
    sorted_indices = np.argsort([abs(c) for c in contributions])[::-1]
    features = [features[i] for i in sorted_indices]
    contributions = [contributions[i] for i in sorted_indices]

    y_pos = np.arange(len(features))

    # Create horizontal bar chart
    colors = [COLORS['pl_positive'] if c >= 0 else COLORS['pl_negative'] for c in contributions]
    bars = ax.barh(y_pos, contributions, color=colors, alpha=0.8)

    # Add value labels
    for bar, contribution in zip(bars, contributions):
        width = bar.get_width()
        ax.annotate(f'{contribution:+.1f}',
                   xy=(width, bar.get_y() + bar.get_height()/2),
                   xytext=(3 if width >= 0 else -3, 0),
                   textcoords='offset points',
                   ha='left' if width >= 0 else 'right',
                   va='center', fontsize=9)

    # Format
    ax.set_yticks(y_pos)
    ax.set_yticklabels(features)
    ax.set_xlabel('Contribution to Score')
    ax.set_title(title)
    ax.axvline(x=0, color='black', linewidth=0.5)
    ax.grid(True, axis='x', color=COLORS['grid'], alpha=0.5)

    chart_frame.figure.tight_layout()
    chart_frame.refresh()


def plot_swap_events_timeline(
    chart_frame: VulnerabilityChartFrame,
    swap_events: List[Dict[str, Any]],
    title: str = "Swap Events Timeline"
) -> None:
    """
    Plot swap events on a timeline.

    Args:
        chart_frame: VulnerabilityChartFrame to plot on
        swap_events: List of swap event dicts
        title: Chart title
    """
    chart_frame.clear()
    ax = chart_frame.figure.add_subplot(111)

    if not swap_events:
        ax.text(0.5, 0.5, "No swap events to display", ha='center', va='center', fontsize=12)
        chart_frame.refresh()
        return

    # Extract data
    dates = [e['date'] if isinstance(e['date'], datetime) else pd.to_datetime(e['date']) for e in swap_events]
    symbols = [e['swapped_symbol'] for e in swap_events]
    pl_diffs = [e['pl_difference_pct'] for e in swap_events]
    outcomes = [e.get('outcome_category', 'NEUTRAL') for e in swap_events]

    # Color by outcome
    color_map = {
        'BENEFITED': COLORS['benefited'],
        'HURT': COLORS['hurt'],
        'NEUTRAL': COLORS['neutral']
    }
    colors = [color_map.get(o, COLORS['neutral']) for o in outcomes]

    # Create scatter plot
    scatter = ax.scatter(dates, pl_diffs, c=colors, s=100, alpha=0.7, edgecolors='black', linewidth=1)

    # Add labels for each point
    for i, (date, diff, symbol) in enumerate(zip(dates, pl_diffs, symbols)):
        ax.annotate(symbol, (date, diff), textcoords="offset points",
                   xytext=(0, 5), ha='center', fontsize=8)

    # Add legend
    legend_elements = [
        Patch(facecolor=COLORS['benefited'], label='Benefited'),
        Patch(facecolor=COLORS['hurt'], label='Hurt'),
        Patch(facecolor=COLORS['neutral'], label='Neutral')
    ]
    ax.legend(handles=legend_elements, loc='upper right')

    # Format
    ax.set_xlabel('Date')
    ax.set_ylabel('P/L Difference (%)')
    ax.set_title(title)
    ax.axhline(y=0, color='black', linewidth=0.5)
    ax.grid(True, color=COLORS['grid'], alpha=0.5)

    ax.xaxis.set_major_formatter(mdates.DateFormatter('%Y-%m-%d'))
    ax.xaxis.set_major_locator(mdates.AutoDateLocator())
    chart_frame.figure.autofmt_xdate()

    chart_frame.figure.tight_layout()
    chart_frame.refresh()


def plot_parameter_sensitivity(
    chart_frame: VulnerabilityChartFrame,
    results: List[Dict[str, Any]],
    x_param: str = 'immunity_days',
    y_metric: str = 'total_pl_difference',
    title: str = "Parameter Sensitivity Analysis"
) -> None:
    """
    Plot parameter sensitivity analysis results.

    Args:
        chart_frame: VulnerabilityChartFrame to plot on
        results: List of analysis results with varying parameters
        x_param: Parameter name for x-axis
        y_metric: Metric name for y-axis
        title: Chart title
    """
    chart_frame.clear()
    ax = chart_frame.figure.add_subplot(111)

    if not results:
        ax.text(0.5, 0.5, "No results to display", ha='center', va='center', fontsize=12)
        chart_frame.refresh()
        return

    # Extract data
    x_values = [r.get(x_param, 0) for r in results]
    y_values = [r.get(y_metric, 0) for r in results]

    # Create line plot with markers
    ax.plot(x_values, y_values, 'o-', color=COLORS['score_line'], linewidth=2, markersize=8)

    # Highlight best value
    best_idx = np.argmax(y_values)
    ax.scatter([x_values[best_idx]], [y_values[best_idx]],
              color=COLORS['benefited'], s=150, zorder=5, marker='*', label='Best')

    # Format
    ax.set_xlabel(x_param.replace('_', ' ').title())
    ax.set_ylabel(y_metric.replace('_', ' ').title())
    ax.set_title(title)
    ax.legend()
    ax.grid(True, color=COLORS['grid'], alpha=0.5)

    chart_frame.figure.tight_layout()
    chart_frame.refresh()


def plot_cumulative_pl_impact(
    chart_frame: VulnerabilityChartFrame,
    trades: List[Dict[str, Any]],
    title: str = "Cumulative P/L Impact"
) -> None:
    """
    Plot cumulative P/L over time for natural vs vulnerability-based exits.

    Args:
        chart_frame: VulnerabilityChartFrame to plot on
        trades: List of trade analysis dicts sorted by exit date
        title: Chart title
    """
    chart_frame.clear()
    ax = chart_frame.figure.add_subplot(111)

    if not trades:
        ax.text(0.5, 0.5, "No data to display", ha='center', va='center', fontsize=12)
        chart_frame.refresh()
        return

    # Sort by exit date
    sorted_trades = sorted(trades, key=lambda t: t.get('exit_date_natural', datetime.now()))

    # Calculate cumulative P/L
    dates = []
    cum_natural = []
    cum_vuln = []

    running_natural = 0
    running_vuln = 0

    for t in sorted_trades:
        exit_date = t.get('exit_date_natural')
        if exit_date is None:
            continue

        if isinstance(exit_date, str):
            exit_date = pd.to_datetime(exit_date)

        running_natural += t.get('pl_natural_dollars', 0)

        if t.get('would_have_been_swapped', False):
            running_vuln += t.get('pl_if_exited_at_vulnerability_dollars', 0)
        else:
            running_vuln += t.get('pl_natural_dollars', 0)

        dates.append(exit_date)
        cum_natural.append(running_natural)
        cum_vuln.append(running_vuln)

    # Plot
    ax.plot(dates, cum_natural, color=COLORS['score_line'], linewidth=2, label='Natural Exit')
    ax.plot(dates, cum_vuln, color=COLORS['threshold_line'], linewidth=2, linestyle='--', label='Vulnerability Exit')

    # Fill area between lines
    ax.fill_between(dates, cum_natural, cum_vuln,
                   where=[v > n for v, n in zip(cum_vuln, cum_natural)],
                   color=COLORS['benefited'], alpha=0.3, label='Vulnerability Better')
    ax.fill_between(dates, cum_natural, cum_vuln,
                   where=[v <= n for v, n in zip(cum_vuln, cum_natural)],
                   color=COLORS['hurt'], alpha=0.3, label='Natural Better')

    # Format
    ax.set_xlabel('Date')
    ax.set_ylabel('Cumulative P/L ($)')
    ax.set_title(title)
    ax.legend(loc='upper left')
    ax.axhline(y=0, color='black', linewidth=0.5)
    ax.grid(True, color=COLORS['grid'], alpha=0.5)

    ax.xaxis.set_major_formatter(mdates.DateFormatter('%Y-%m-%d'))
    ax.xaxis.set_major_locator(mdates.AutoDateLocator())
    chart_frame.figure.autofmt_xdate()

    chart_frame.figure.tight_layout()
    chart_frame.refresh()
